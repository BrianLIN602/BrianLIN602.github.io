<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>日本旅遊小幫手</title>
    
    <!-- PWA / Mobile App Config -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="日本旅遊">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1c1917">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/827/827056.png"> 
    
    <!-- Android Manifest (Inline for portability) -->
    <link rel="manifest" href='data:application/manifest+json,%7B%22name%22%3A%22%E6%97%A5%E6%9C%AC%E6%97%85%E9%81%8A%E5%B0%8F%E5%B9%AB%E6%89%8B%22%2C%22short_name%22%3A%22%E6%97%A5%E6%9C%AC%E6%97%85%E9%81%8A%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%231c1917%22%2C%22theme_color%22%3A%22%231c1917%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22https%3A%2F%2Fcdn-icons-png.flaticon.com%2F512%2F827%2F827056.png%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fpng%22%7D%5D%7D'>

    <!-- Fonts & CSS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        muji: { base: '#f4f4f0', text: '#444444', accent: '#7b7b7b', card: '#ffffff', primary: '#8c8c88', alert: '#bf6a6a' },
                        tokyo: { red: '#ce3138', paper: '#fcf9f2', dot: '#e6e2d3' }
                    },
                    fontFamily: { sans: ['"Noto Sans TC"', 'sans-serif'], serif: ['"Noto Serif TC"', 'serif'] }
                }
            }
        }
    </script>

    <style>
        /* Shared Styles */
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; transition: background-color 0.3s; overscroll-behavior-y: none; }
        
        /* Dark Mode - Tokyo Night Style */
        html.dark body { background-color: #050505; }
        html.dark #app-container { 
            background-color: rgba(0, 0, 0, 0.65); /* Deep dark overlay */
            color: #e5e7eb; 
            isolation: isolate;
        }

        /* Dark Mode Background Layer (Tokyo Night View) */
        html.dark #app-container::before {
            content: "";
            position: absolute;
            inset: 0;
            z-index: -1;
            /* Real Photo: Tokyo Tower Night View */
            background-image: url('https://images.unsplash.com/photo-1540959733332-eab4deabeeaf?auto=format&fit=crop&w=1000&q=80');
            background-repeat: no-repeat;
            background-position: center 20%; /* Focus on the skyline */
            background-size: cover;
            opacity: 0.5; /* Visible background */
            filter: blur(3px) brightness(0.7); /* Blur to keep text readable */
        }

        /* Glassmorphism for Dark Mode Cards */
        html.dark .bg-stone-800, 
        html.dark .bg-muji-card,
        html.dark .bg-white {
            /* Override tailwind bg colors in dark mode for glass effect */
            background-color: rgba(30, 30, 35, 0.6) !important; 
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08) !important; /* Subtle border */
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        /* Neon Glow for Title in Dark Mode */
        html.dark #app-title {
            text-shadow: 0 0 15px rgba(206, 49, 56, 0.5); /* Tokyo Red Glow */
        }

        /* Light Mode - Tokyo/Japan Style (Real Photo Background) */
        html:not(.dark) body {
            background-color: #dedede; 
        }
        html:not(.dark) #app-container {
            background-color: rgba(252, 249, 242, 0.85); /* Washi color with transparency */
            color: #444444;
            box-shadow: 0 0 40px rgba(0,0,0,0.15);
            /* Important: Create a stacking context for the pseudo-element */
            isolation: isolate; 
        }
        
        /* Real Photo Background Layer */
        html:not(.dark) #app-container::before {
            content: "";
            position: absolute;
            inset: 0; /* top:0, right:0, bottom:0, left:0 */
            z-index: -1;
            /* Real Photo: Mount Fuji with Cherry Blossoms */
            background-image: url('https://images.unsplash.com/photo-1490806843957-31f4c9a91c65?auto=format&fit=crop&w=1000&q=80');
            background-repeat: no-repeat;
            background-position: center;
            background-size: cover; /* Cover the whole area */
            opacity: 0.18; /* Low opacity to keep text readable */
            filter: grayscale(10%) sepia(10%); /* Subtle vintage feel */
        }

        /* Tokyo Red Accent for Light Mode Title */
        html:not(.dark) .tokyo-accent { color: #ce3138; }

        #app-container { min-height: 100vh; padding-top: env(safe-area-inset-top); padding-bottom: calc(80px + env(safe-area-inset-bottom)); transition: background-color 0.3s, color 0.3s; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .muji-checkbox:checked { background-color: #8c8c88; border-color: #8c8c88; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; backdrop-filter: blur(2px); }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-box { background: white; width: 85%; max-width: 320px; border-radius: 16px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transform: scale(0.95); transition: transform 0.2s; max-height: 85vh; overflow-y: auto; }
        .modal-overlay.active .modal-box { transform: scale(1); }
        html.dark .modal-box { background: #292524; color: #e5e5e5; border: 1px solid #44403c; }
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px); background: rgba(40, 40, 40, 0.9); color: white; padding: 10px 20px; border-radius: 50px; font-size: 13px; opacity: 0; transition: all 0.3s; pointer-events: none; z-index: 3000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .toast.active { opacity: 1; transform: translateX(-50%) translateY(0); }
        html.dark .toast { background: rgba(255, 255, 255, 0.9); color: #1c1917; }
        
        /* Progress Bar for Expenses */
        .progress-bar-bg { background-color: #e5e5e5; border-radius: 99px; height: 6px; width: 100%; overflow: hidden; margin-top: 4px; }
        html.dark .progress-bar-bg { background-color: #44403c; }
        .progress-bar-fill { height: 100%; border-radius: 99px; transition: width 0.5s ease-in-out; }

        /* Hide elements during capture */
        .capturing .no-capture { display: none !important; }
    </style>
</head>
<body>

    <div id="app-container" class="max-w-md mx-auto relative overflow-hidden">
        
        <!-- Header -->
        <header class="bg-white/20 dark:bg-black/30 sticky top-0 z-50 px-6 py-4 border-b border-white/20 dark:border-white/10 flex justify-between items-center backdrop-blur-md transition-colors duration-300">
            <div>
                <h1 id="app-title" class="font-serif text-xl font-bold text-muji-text dark:text-stone-100 tracking-widest flex items-center gap-2">
                    <i class="fa-solid fa-torii-gate tokyo-accent dark:text-stone-500 text-lg opacity-80"></i>
                    <span>東京旅遊</span>
                </h1>
                <p id="app-date" class="text-xs text-muji-accent dark:text-stone-400 mt-0.5 ml-7">2026.01.11 - 01.18</p>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="toggleDarkMode()" class="text-muji-primary dark:text-stone-400 hover:text-tokyo-red dark:hover:text-stone-200 transition p-1">
                    <i id="dark-mode-icon" class="fa-solid fa-moon text-lg"></i>
                </button>
            </div>
        </header>

        <!-- CONTENT: PLAN -->
        <main class="p-4">
            <div id="tab-plan" class="tab-content active">
                
                <!-- Split Layout for Flight & Weather -->
                <div class="grid grid-cols-2 gap-3 mb-6">
                    
                    <!-- Left: Compact Flight Card -->
                    <div class="bg-white dark:bg-stone-800 p-4 rounded-xl shadow-sm border border-stone-100 dark:border-stone-700 transition-colors duration-300 relative group flex flex-col justify-between">
                        <button onclick="openFlightModal()" class="absolute top-2 right-2 text-stone-300 hover:text-stone-500 dark:hover:text-stone-300 p-1"><i class="fa-solid fa-pen text-xs"></i></button>
                        <h3 class="text-xs font-bold text-muji-primary dark:text-stone-400 mb-2 uppercase tracking-wide">航班</h3>
                        
                        <!-- Outbound Compact -->
                        <div class="mb-3 border-b border-stone-100 dark:border-stone-700 pb-2">
                            <div class="flex justify-between items-end text-center">
                                <div>
                                    <div id="disp-out-dep" class="text-lg font-bold text-muji-text dark:text-stone-100 leading-none">TPE</div>
                                    <div id="disp-out-dep-time" class="text-[10px] font-mono text-muji-accent dark:text-stone-400 mt-1">02:30</div>
                                </div>
                                <div class="flex flex-col items-center pb-1">
                                    <i class="fa-solid fa-plane text-xs text-stone-300 transform rotate-45 mb-0.5"></i>
                                    <div id="disp-out-flight" class="text-[9px] text-stone-400 tracking-wider">GK12</div>
                                </div>
                                <div>
                                    <div id="disp-out-arr" class="text-lg font-bold text-muji-text dark:text-stone-100 leading-none">NRT</div>
                                    <div id="disp-out-arr-time" class="text-[10px] font-mono text-muji-accent dark:text-stone-400 mt-1">06:35</div>
                                </div>
                            </div>
                        </div>

                        <!-- Inbound Compact -->
                        <div>
                            <div class="flex justify-between items-end text-center">
                                <div>
                                    <div id="disp-in-dep" class="text-lg font-bold text-muji-text dark:text-stone-100 leading-none">NRT</div>
                                    <div id="disp-in-dep-time" class="text-[10px] font-mono text-muji-accent dark:text-stone-400 mt-1">--:--</div>
                                </div>
                                <div class="flex flex-col items-center pb-1">
                                    <i class="fa-solid fa-plane text-xs text-stone-300 transform rotate-45 mb-0.5"></i>
                                    <div id="disp-in-flight" class="text-[9px] text-stone-400 tracking-wider">--</div>
                                </div>
                                <div>
                                    <div id="disp-in-arr" class="text-lg font-bold text-muji-text dark:text-stone-100 leading-none">TPE</div>
                                    <div id="disp-in-arr-time" class="text-[10px] font-mono text-muji-accent dark:text-stone-400 mt-1">--:--</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right: Weather Card -->
                    <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl shadow-sm border border-blue-100 dark:border-blue-900/30 flex flex-col justify-between relative overflow-hidden cursor-pointer" onclick="updateWeather(true)">
                        <div class="absolute -right-2 -top-2 opacity-10 text-6xl text-blue-500"><i class="fa-solid fa-cloud"></i></div>
                        <div class="flex justify-between items-start z-10">
                            <h3 class="text-xs font-bold text-blue-800 dark:text-blue-200">目前天氣</h3>
                            <button class="text-blue-400 hover:text-blue-600 animate-pulse"><i class="fa-solid fa-location-arrow text-[10px]"></i></button>
                        </div>
                        
                        <div class="flex items-center justify-between mt-1 z-10">
                            <div class="text-3xl font-bold text-blue-600 dark:text-blue-300 tracking-tighter" id="weather-temp-val">--°</div>
                            <i id="weather-icon-main" class="fa-solid fa-cloud-sun text-2xl text-blue-400 dark:text-blue-300"></i>
                        </div>
                        
                        <div class="text-[10px] text-blue-500 dark:text-blue-400 mt-2 text-right z-10 font-medium truncate" id="weather-desc">點擊更新</div>
                    </div>
                </div>

                <!-- Day Selector -->
                <div id="day-selector" class="flex overflow-x-auto gap-2 mb-4 pb-2 no-scrollbar items-center"></div>

                <!-- ADD PLAN FORM (Hidden initially) -->
                <div id="add-plan-form" class="hidden bg-white dark:bg-stone-800 p-5 rounded-xl shadow-lg border border-stone-100 dark:border-stone-700 mb-6 transition-all duration-300 scroll-mt-20">
                    <h3 id="plan-form-title" class="text-sm font-bold text-muji-primary dark:text-stone-400 mb-3">新增行程</h3>
                    <div class="space-y-3">
                        <div><label class="block text-xs text-stone-500 dark:text-stone-400 mb-1">選擇日期</label><select id="plan-day-select" class="w-full bg-muji-base dark:bg-stone-900 dark:text-white border-none rounded-lg text-sm px-3 py-2"></select></div>
                        <div class="flex gap-2">
                            <div class="w-1/3"><label class="block text-xs text-stone-500 dark:text-stone-400 mb-1">時間</label><input type="time" id="plan-time" class="w-full bg-muji-base dark:bg-stone-900 dark:text-white border-none rounded-lg text-sm px-2 py-2"></div>
                            <div class="w-2/3"><label class="block text-xs text-stone-500 dark:text-stone-400 mb-1">類型</label><select id="plan-type" class="w-full bg-muji-base dark:bg-stone-900 dark:text-white border-none rounded-lg text-sm px-3 py-2"><option value="spot">景點</option><option value="food">美食</option><option value="transport">交通</option><option value="shopping">購物</option><option value="hotel">住宿</option></select></div>
                        </div>
                        <div><label class="block text-xs text-stone-500 dark:text-stone-400 mb-1">行程內容</label><input type="text" id="plan-text" placeholder="例：前往淺草寺參拜" class="w-full bg-muji-base dark:bg-stone-900 dark:text-white border-none rounded-lg text-sm px-3 py-2"></div>
                        <div><label class="block text-xs text-stone-500 dark:text-stone-400 mb-1">Google Maps 連結 (選填)</label><input type="text" id="plan-link" placeholder="貼上地圖網址" class="w-full bg-muji-base dark:bg-stone-900 dark:text-white border-none rounded-lg text-sm px-3 py-2"></div>
                        <div class="flex items-center gap-2"><input type="checkbox" id="plan-important" class="muji-checkbox w-4 h-4 rounded text-amber-500 focus:ring-amber-500"><label for="plan-important" class="text-xs text-stone-600 dark:text-stone-300">標記為重要行程</label></div>
                        <div class="flex gap-2 pt-2"><button onclick="togglePlanForm()" class="flex-1 bg-stone-200 dark:bg-stone-700 text-stone-600 dark:text-stone-300 rounded-lg text-xs py-2">取消</button><button onclick="savePlanEvent()" class="flex-1 bg-stone-700 dark:bg-stone-600 text-white rounded-lg text-xs font-bold py-2">儲存</button></div>
                    </div>
                </div>

                <div id="itinerary-container" class="space-y-6"></div>
                <div class="text-center mt-6 mb-8"></div>
            </div>

            <!-- 2. GUIDE -->
            <div id="tab-guide" class="tab-content">
                <div class="mb-6"><h2 class="font-serif text-2xl text-muji-text dark:text-stone-100 mb-2">深度導覽</h2><p class="text-sm text-muji-accent dark:text-stone-400">已自動同步行程中的「景點、美食與購物」。</p></div>
                <button onclick="toggleGuideForm()" class="w-full mb-6 border-2 border-dashed border-stone-300 dark:border-stone-700 text-stone-400 dark:text-stone-500 rounded-xl p-4 flex flex-col items-center justify-center hover:bg-stone-50 dark:hover:bg-stone-800 transition group active:scale-95"><i class="fa-solid fa-plus text-xl mb-1 group-hover:scale-110 transition-transform"></i><span class="text-xs font-bold">手動新增導覽</span></button>
                <div id="add-guide-form" class="hidden bg-white dark:bg-stone-800 p-5 rounded-xl shadow-lg border border-stone-100 dark:border-stone-700 mb-6"><h3 class="text-sm font-bold text-muji-primary dark:text-stone-400 mb-3">撰寫新導覽</h3>
                    <div class="space-y-3"><input type="text" id="guide-title" placeholder="景點名稱" class="w-full bg-muji-base dark:bg-stone-900 dark:text-white border-none rounded-lg text-sm px-3 py-2"><textarea id="guide-desc" rows="4" placeholder="介紹內容..." class="w-full bg-muji-base dark:bg-stone-900 dark:text-white border-none rounded-lg text-sm px-3 py-2 resize-none"></textarea><input type="text" id="guide-tip" placeholder="冷知識 (選填)" class="w-full bg-stone-100 dark:bg-stone-700 dark:text-white border-none rounded-lg text-xs px-3 py-2 text-stone-600 placeholder-stone-400"><div class="flex gap-2 pt-2"><button onclick="toggleGuideForm()" class="flex-1 bg-stone-200 dark:bg-stone-700 text-stone-600 dark:text-stone-300 rounded-lg text-xs py-2">取消</button><button onclick="addGuideItem()" class="flex-1 bg-stone-700 dark:bg-stone-600 text-white rounded-lg text-xs font-bold py-2">新增</button></div></div>
                </div>
                <div id="guide-container"></div>
            </div>

            <!-- 3. WALLET -->
            <div id="tab-wallet" class="tab-content">
                <div class="bg-stone-800 dark:bg-black text-stone-100 p-5 rounded-xl shadow-lg mb-6 relative overflow-hidden transition-colors duration-300">
                    <div class="absolute -right-4 -top-4 text-stone-700 dark:text-stone-800 opacity-20 text-9xl"><i class="fa-solid fa-coins"></i></div>
                    <div class="flex justify-between items-center mb-4"><div class="text-xs text-stone-400" id="rate-status">當前匯率 (日幣/台幣)</div><div class="flex items-center gap-2"><button id="rate-refresh-btn" onclick="fetchExchangeRate()" class="text-stone-500 hover:text-stone-300 text-xs"><i class="fa-solid fa-rotate-right"></i></button><input type="number" id="exchange-rate" value="0.22" step="0.0001" class="w-20 bg-stone-700 dark:bg-stone-900 border-none rounded text-center text-sm text-white focus:ring-1 focus:ring-stone-500"></div></div>
                    <div class="mb-2"><input type="text" id="calc-input" inputmode="decimal" placeholder="輸入金額 (如 500+200)" class="w-full bg-transparent text-3xl font-mono text-right border-b border-stone-600 focus:outline-none focus:border-stone-400 pb-2 placeholder-stone-600 dark:placeholder-stone-700"></div>
                    <div class="flex justify-end items-end gap-2"><div class="text-stone-400 text-sm">≈ NT$</div><div id="calc-result-twd" class="text-xl font-bold">0</div></div>
                    
                    <!-- NEW: Rate Reference Table (Fixed HTML Structure) -->
                    <div id="rate-reference" class="grid grid-cols-4 gap-2 mt-4 pt-4 border-t border-white/10"></div>
                </div>

                <!-- Expense Chart -->
                <div id="expense-analysis" class="bg-white dark:bg-stone-800 p-5 rounded-xl shadow-sm border border-stone-100 dark:border-stone-700 mb-6">
                    <h3 class="text-sm font-bold text-muji-primary dark:text-stone-400 mb-3">消費統計</h3>
                    <div id="expense-bars" class="space-y-3"></div>
                </div>

                <div class="bg-muji-card dark:bg-stone-800 p-5 rounded-xl shadow-sm border border-stone-100 dark:border-stone-700 mb-6 transition-colors duration-300">
                    <h3 class="text-sm font-bold text-muji-primary dark:text-stone-400 mb-4">新增消費</h3>
                    <div class="space-y-3">
                        <div class="flex gap-2">
                            <input type="text" id="expense-name" placeholder="品項" class="flex-[2] bg-muji-base dark:bg-stone-900 dark:text-white border-none rounded-lg text-sm px-3 py-3">
                            <select id="expense-cat" class="flex-[1] bg-muji-base dark:bg-stone-900 dark:text-white border-none rounded-lg text-sm px-2 py-3 text-center">
                                <option value="food">食</option>
                                <option value="transport">行</option>
                                <option value="shopping">購</option>
                                <option value="ticket">樂</option>
                                <option value="hotel">住</option>
                                <option value="other">他</option>
                            </select>
                        </div>
                        <input type="number" id="expense-amount" placeholder="¥ 金額" class="w-full bg-muji-base dark:bg-stone-900 dark:text-white border-none rounded-lg text-sm px-3 py-3">
                        <div class="flex gap-2">
                            <label class="flex-1 bg-stone-100 dark:bg-stone-700 text-stone-500 dark:text-stone-300 rounded-lg flex items-center justify-center gap-2 cursor-pointer hover:bg-stone-200 dark:hover:bg-stone-600 transition py-3"><i class="fa-solid fa-camera"></i><span class="text-xs">拍照</span><input type="file" id="expense-photo" accept="image/*" capture="environment" class="hidden"></label>
                            <button onclick="addExpense()" class="flex-1 bg-stone-700 dark:bg-stone-600 text-white rounded-lg text-sm font-bold hover:bg-stone-800 dark:hover:bg-stone-500 transition py-3">儲存</button>
                        </div>
                        <div id="photo-preview-name" class="text-xs text-muji-primary dark:text-stone-400 mt-1 hidden text-center truncate"></div>
                    </div>
                </div>
                <h3 class="text-sm font-bold text-muji-primary dark:text-stone-400 mb-3 px-1">消費紀錄</h3><div id="expense-list" class="space-y-3 pb-20"></div>
            </div>

            <!-- 4. LISTS -->
            <div id="tab-lists" class="tab-content">
                <div class="bg-muji-card dark:bg-stone-800 p-5 rounded-xl shadow-sm border border-stone-100 dark:border-stone-700 mb-6 transition-colors duration-300">
                    <div class="flex justify-between items-center mb-4 border-b border-stone-100 dark:border-stone-700 pb-2"><h3 class="text-sm font-bold text-muji-primary dark:text-stone-400 uppercase">行前準備清單 (僅本機)</h3><span id="checklist-progress" class="text-xs bg-stone-200 dark:bg-stone-700 px-2 py-0.5 rounded text-stone-600 dark:text-stone-300">0/0</span></div>
                    <div class="flex gap-2 mb-4"><input type="text" id="new-checklist-item" placeholder="新增項目..." class="flex-1 bg-muji-base dark:bg-stone-900 dark:text-white border-none rounded-lg text-sm px-3 py-2"><button onclick="addChecklistItem()" class="bg-stone-700 dark:bg-stone-600 text-white rounded-lg px-4 py-2 text-sm"><i class="fa-solid fa-plus"></i></button></div>
                    <ul id="checklist-container" class="space-y-3"></ul>
                </div>
                <div class="bg-muji-card dark:bg-stone-800 p-5 rounded-xl shadow-sm border border-stone-100 dark:border-stone-700 transition-colors duration-300"><h3 class="text-sm font-bold text-muji-primary dark:text-stone-400 mb-3 uppercase">個人備忘錄 (僅本機)</h3><textarea id="memo-area" class="w-full h-40 bg-muji-base dark:bg-stone-900 dark:text-white rounded-lg p-3 text-sm text-muji-text focus:outline-none resize-none leading-relaxed" placeholder="輸入文字..."></textarea><div class="flex justify-between mt-2"><span class="text-[10px] text-muji-accent dark:text-stone-500 pt-1">自動儲存</span><button onclick="parseMemoLinks()" class="text-xs text-stone-500 dark:text-stone-400 underline">更新連結</button></div><div id="memo-links" class="mt-3 flex flex-wrap gap-2"></div></div>
            </div>

            <!-- 5. INFO -->
            <div id="tab-info" class="tab-content">
                <div class="bg-muji-card dark:bg-stone-800 p-5 rounded-xl shadow-sm border border-stone-100 dark:border-stone-700 mb-6 transition-colors duration-300 border-l-4 border-l-amber-400">
                    <h3 class="text-sm font-bold text-muji-primary dark:text-stone-400 mb-3 uppercase border-b border-stone-100 dark:border-stone-700 pb-2 flex justify-between items-center"><span><i class="fa-solid fa-cloud mr-2"></i>旅程同步設定</span><span id="sync-status" class="text-[10px] text-stone-400 font-normal bg-stone-100 dark:bg-stone-700 px-2 py-0.5 rounded-full">檢查中...</span></h3>
                    <div class="space-y-4">
                        <p class="text-[10px] text-stone-400 dark:text-stone-500 leading-relaxed"><i class="fa-solid fa-circle-info mr-1"></i>注意：僅同步「行程、導覽、航班、標題日期」。<br>「記帳、清單、備忘錄」為個人資料，僅儲存於此裝置。</p>
                        <div><label class="block text-xs text-stone-500 dark:text-stone-400 mb-1">旅程代碼 (分享給親友)</label><div class="flex gap-2"><div id="current-trip-id" class="flex-1 bg-stone-100 dark:bg-stone-900 dark:text-white rounded-lg p-3 text-center font-mono font-bold text-lg tracking-wider select-all">...</div><button onclick="copyTripId()" class="bg-stone-200 dark:bg-stone-700 text-stone-600 dark:text-stone-300 px-4 rounded-lg"><i class="fa-regular fa-copy"></i></button></div></div><div><label class="block text-xs text-stone-500 dark:text-stone-400 mb-1">加入其他旅程</label><div class="flex gap-2"><input type="text" id="join-trip-input" placeholder="輸入代碼" class="flex-1 bg-muji-base dark:bg-stone-900 dark:text-white border-none rounded-lg text-sm px-3 py-2 uppercase"><button onclick="joinTrip()" class="bg-stone-700 dark:bg-stone-600 text-white px-4 rounded-lg text-sm font-bold">連線</button></div></div>
                    </div>
                </div>
                <div class="bg-muji-card dark:bg-stone-800 p-5 rounded-xl shadow-sm border border-stone-100 dark:border-stone-700 mb-6"><h3 class="text-sm font-bold text-muji-primary dark:text-stone-400 mb-4 uppercase border-b border-stone-100 dark:border-stone-700 pb-2">資料備份 (本機)</h3><div class="flex gap-2"><button onclick="exportLocalData()" class="flex-1 bg-stone-100 dark:bg-stone-700 text-stone-600 dark:text-stone-300 rounded-lg text-xs py-2 hover:bg-stone-200"><i class="fa-solid fa-download mr-1"></i>匯出備份</button><label class="flex-1 bg-stone-100 dark:bg-stone-700 text-stone-600 dark:text-stone-300 rounded-lg text-xs py-2 hover:bg-stone-200 text-center cursor-pointer"><i class="fa-solid fa-upload mr-1"></i>匯入還原<input type="file" id="import-file" accept=".json" class="hidden" onchange="importLocalData(this)"></label></div></div>
                <div class="bg-muji-card dark:bg-stone-800 p-5 rounded-xl shadow-sm border border-stone-100 dark:border-stone-700 mb-6"><h3 class="text-sm font-bold text-muji-primary dark:text-stone-400 mb-4 uppercase border-b border-stone-100 dark:border-stone-700 pb-2">旅程設定</h3><div class="space-y-3"><div><label class="block text-xs text-stone-500 dark:text-stone-400 mb-1">標題 (同步)</label><input type="text" id="setting-title" class="w-full bg-muji-base dark:bg-stone-900 dark:text-white border-none rounded-lg text-sm px-3 py-2"></div><div><label class="block text-xs text-stone-500 dark:text-stone-400 mb-1">日期 (同步)</label><input type="text" id="setting-date" class="w-full bg-muji-base dark:bg-stone-900 dark:text-white border-none rounded-lg text-sm px-3 py-2"></div><button onclick="saveShared()" class="w-full bg-stone-700 dark:bg-stone-600 text-white rounded-lg text-sm font-bold py-2 mt-2">儲存設定</button></div></div>
                <div class="grid grid-cols-2 gap-4 mb-6"><a href="https://www.jma.go.jp/jma/index.html" target="_blank" class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl text-center border border-blue-100 dark:border-blue-900/30 block"><i class="fa-solid fa-cloud-sun-rain text-2xl text-blue-400 mb-2"></i><div class="text-sm font-bold text-stone-600 dark:text-stone-200">天氣</div></a><a href="https://www.google.com/maps/search/Police+Station" target="_blank" class="bg-red-50 dark:bg-red-900/20 p-4 rounded-xl text-center border border-red-100 dark:border-red-900/30 block"><i class="fa-solid fa-shield-halved text-2xl text-red-400 mb-2"></i><div class="text-sm font-bold text-stone-600 dark:text-stone-200">警察</div></a></div>
                <div class="bg-muji-card dark:bg-stone-800 p-5 rounded-xl shadow-sm border border-stone-100 dark:border-stone-700 mb-6"><h3 class="text-sm font-bold text-muji-primary dark:text-stone-400 mb-3 uppercase border-b border-stone-100 dark:border-stone-700 pb-2">緊急聯絡</h3><div class="space-y-3"><div class="flex justify-between text-sm"><span class="text-muji-text dark:text-stone-200">救護車 / 火警</span><span class="font-bold text-red-500 font-mono">119</span></div><div class="flex justify-between text-sm"><span class="text-muji-text dark:text-stone-200">東京辦事處</span><span class="font-bold text-muji-text dark:text-stone-200 font-mono">080-1009-7179</span></div></div></div>
                <div class="text-center mt-8 mb-4"><button onclick="clearAllData()" class="text-xs text-red-300 border border-red-100 dark:border-red-900/50 px-3 py-1 rounded">重置本機與雲端資料</button></div>
            </div>
        </main>

        <!-- Navigation & Modals -->
        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white/80 dark:bg-stone-900 border-t border-stone-200 dark:border-stone-800 px-2 py-2 flex justify-around items-end z-50 text-[10px] font-medium text-stone-400 pb-safe transition-colors duration-300 backdrop-blur-md">
            <button onclick="switchTab('plan')" class="nav-btn active flex flex-col items-center gap-1 p-2 w-1/5 text-muji-primary dark:text-stone-500" data-target="plan"><i class="fa-regular fa-calendar-days text-lg mb-0.5"></i><span>行程</span></button>
            <button onclick="switchTab('guide')" class="nav-btn flex flex-col items-center gap-1 p-2 w-1/5 hover:text-stone-600" data-target="guide"><i class="fa-solid fa-book-open text-lg mb-0.5"></i><span>導覽</span></button>
            <button onclick="switchTab('wallet')" class="nav-btn flex flex-col items-center gap-1 p-2 w-1/5 -mt-6" data-target="wallet"><div class="bg-stone-700 dark:bg-stone-200 text-white dark:text-stone-900 rounded-full w-12 h-12 flex items-center justify-center shadow-lg"><i class="fa-solid fa-wallet text-xl"></i></div><span class="mt-1">錢包</span></button>
            <button onclick="switchTab('lists')" class="nav-btn flex flex-col items-center gap-1 p-2 w-1/5 hover:text-stone-600" data-target="lists"><i class="fa-solid fa-list-check text-lg mb-0.5"></i><span>清單</span></button>
            <button onclick="switchTab('info')" class="nav-btn flex flex-col items-center gap-1 p-2 w-1/5 hover:text-stone-600" data-target="info"><i class="fa-solid fa-circle-info text-lg mb-0.5"></i><span>資訊</span></button>
        </nav>

        <div id="confirm-modal" class="modal-overlay"><div class="modal-box"><h3 class="font-bold text-lg mb-2 dark:text-white">確認</h3><p id="confirm-message" class="text-sm text-gray-500 mb-6 dark:text-gray-400"></p><div class="flex justify-end gap-3"><button onclick="closeModal('confirm-modal')" class="px-4 py-2 text-sm text-gray-500">取消</button><button id="confirm-btn" class="px-4 py-2 text-sm bg-stone-700 text-white rounded">確定</button></div></div></div>
        <div id="edit-day-modal" class="modal-overlay"><div class="modal-box"><h3 class="font-bold text-lg mb-4 dark:text-white">編輯標題</h3><div class="space-y-4 mb-6"><input type="text" id="edit-day-date" class="w-full bg-stone-100 dark:bg-stone-900 dark:text-white p-2 rounded"><input type="text" id="edit-day-title" class="w-full bg-stone-100 dark:bg-stone-900 dark:text-white p-2 rounded"></div><div class="flex justify-end gap-3"><button onclick="closeModal('edit-day-modal')" class="text-sm text-gray-500">取消</button><button id="save-day-btn" class="text-sm bg-stone-700 text-white px-4 py-2 rounded">儲存</button></div></div></div>
        <div id="edit-flight-modal" class="modal-overlay"><div class="modal-box"><h3 class="font-bold text-lg mb-4 dark:text-white">編輯航班</h3><div class="space-y-3 mb-6">
            <div class="text-[10px] text-gray-500">去程 (Dep/Arr/No.)</div>
            <div class="flex gap-2"><input type="text" id="edit-out-dep" class="w-1/3 bg-stone-100 dark:bg-stone-900 dark:text-white p-2 rounded text-sm"><input type="time" id="edit-out-dep-time" class="w-2/3 bg-stone-100 dark:bg-stone-900 dark:text-white p-2 rounded text-sm"></div>
            <div class="flex gap-2"><input type="text" id="edit-out-arr" class="w-1/3 bg-stone-100 dark:bg-stone-900 dark:text-white p-2 rounded text-sm"><input type="time" id="edit-out-arr-time" class="w-2/3 bg-stone-100 dark:bg-stone-900 dark:text-white p-2 rounded text-sm"></div>
            <input type="text" id="edit-out-num" class="w-full bg-stone-100 dark:bg-stone-900 dark:text-white p-2 rounded text-sm">
            <div class="text-[10px] text-gray-500 mt-2">回程 (Dep/Arr/No.)</div>
            <div class="flex gap-2"><input type="text" id="edit-in-dep" class="w-1/3 bg-stone-100 dark:bg-stone-900 dark:text-white p-2 rounded text-sm"><input type="time" id="edit-in-dep-time" class="w-2/3 bg-stone-100 dark:bg-stone-900 dark:text-white p-2 rounded text-sm"></div>
            <div class="flex gap-2"><input type="text" id="edit-in-arr" class="w-1/3 bg-stone-100 dark:bg-stone-900 dark:text-white p-2 rounded text-sm"><input type="time" id="edit-in-arr-time" class="w-2/3 bg-stone-100 dark:bg-stone-900 dark:text-white p-2 rounded text-sm"></div>
            <input type="text" id="edit-in-num" class="w-full bg-stone-100 dark:bg-stone-900 dark:text-white p-2 rounded text-sm">
        </div><div class="flex justify-end gap-3"><button onclick="closeModal('edit-flight-modal')" class="text-sm text-gray-500">取消</button><button onclick="saveFlightInfo()" class="text-sm bg-stone-700 text-white px-4 py-2 rounded">儲存</button></div></div></div>
        
        <!-- NEW: Move Day Modal -->
        <div id="move-day-modal" class="modal-overlay">
            <div class="modal-box">
                <h3 class="font-bold text-lg mb-4 dark:text-white">移動天數</h3>
                <p class="text-sm text-gray-500 mb-4 dark:text-gray-400">將目前行程移動至...</p>
                <select id="move-day-select" class="w-full bg-stone-100 dark:bg-stone-900 dark:text-white p-2 rounded text-sm mb-6"></select>
                <div class="flex justify-end gap-3">
                    <button onclick="closeModal('move-day-modal')" class="text-sm text-gray-500">取消</button>
                    <button id="save-move-day-btn" class="text-sm bg-stone-700 text-white px-4 py-2 rounded">確定</button>
                </div>
            </div>
        </div>

        <!-- PLAN EDIT MODAL -->
        <div id="edit-plan-modal" class="modal-overlay"><div class="modal-box"><h3 class="font-bold text-lg mb-4 dark:text-white">編輯行程</h3><div class="space-y-3 mb-6"><div><label class="block text-xs text-stone-500 dark:text-stone-400 mb-1">日期 (可移動)</label><select id="edit-plan-day" class="w-full bg-stone-100 dark:bg-stone-900 dark:text-white p-2 rounded text-sm"></select></div><div class="flex gap-2"><div class="w-1/3"><label class="block text-xs text-stone-500 dark:text-stone-400 mb-1">時間</label><input type="time" id="edit-plan-time" class="w-full bg-stone-100 dark:bg-stone-900 dark:text-white p-2 rounded text-sm"></div><div class="w-2/3"><label class="block text-xs text-stone-500 dark:text-stone-400 mb-1">類型</label><select id="edit-plan-type" class="w-full bg-stone-100 dark:bg-stone-900 dark:text-white p-2 rounded text-sm"><option value="spot">景點</option><option value="food">美食</option><option value="transport">交通</option><option value="shopping">購物</option><option value="hotel">住宿</option></select></div></div><div><label class="block text-xs text-stone-500 dark:text-stone-400 mb-1">內容</label><input type="text" id="edit-plan-text" class="w-full bg-stone-100 dark:bg-stone-900 dark:text-white p-2 rounded text-sm"></div><div><label class="block text-xs text-stone-500 dark:text-stone-400 mb-1">連結</label><input type="text" id="edit-plan-link" class="w-full bg-stone-100 dark:bg-stone-900 dark:text-white p-2 rounded text-sm"></div><div class="flex items-center gap-2"><input type="checkbox" id="edit-plan-important" class="muji-checkbox w-4 h-4"><label for="edit-plan-important" class="text-xs text-stone-600 dark:text-stone-300">重要</label></div></div><div class="flex justify-end gap-3"><button onclick="closeModal('edit-plan-modal')" class="text-sm text-gray-500">取消</button><button onclick="saveEditedPlanEvent()" class="text-sm bg-stone-700 text-white px-4 py-2 rounded">儲存</button></div></div></div>

        <div id="edit-guide-modal" class="modal-overlay"><div class="modal-box"><h3 class="font-bold text-lg mb-4 dark:text-white">編輯介紹</h3><input type="hidden" id="edit-guide-id"><div class="space-y-3 mb-6"><div class="flex gap-2"><input type="text" id="edit-guide-title" class="flex-1 bg-stone-100 dark:bg-stone-900 dark:text-white p-2 rounded text-sm" readonly><a id="edit-guide-search" href="#" target="_blank" class="bg-blue-100 text-blue-600 px-3 rounded flex items-center"><i class="fa-brands fa-google"></i></a></div><textarea id="edit-guide-desc" rows="5" class="w-full bg-stone-100 dark:bg-stone-900 dark:text-white p-2 rounded text-sm"></textarea><input type="text" id="edit-guide-tip" class="w-full bg-stone-100 dark:bg-stone-900 dark:text-white p-2 rounded text-sm" placeholder="冷知識"></div><div class="flex justify-end gap-3"><button onclick="closeModal('edit-guide-modal')" class="text-sm text-gray-500">取消</button><button id="save-guide-btn" class="text-sm bg-stone-700 text-white px-4 py-2 rounded">儲存</button></div></div></div>
        <div id="image-modal" class="modal-overlay"><div class="modal-box w-full max-w-lg p-0 overflow-hidden relative"><button onclick="closeModal('image-modal')" class="absolute top-2 right-2 text-gray-500 bg-white rounded-full w-8 h-8 flex items-center justify-center z-10"><i class="fa-solid fa-xmark"></i></button><div class="p-4 bg-stone-100 dark:bg-stone-900 text-center"><h3 class="text-sm font-bold text-muji-text dark:text-white mb-2">行程圖卡</h3><p class="text-[10px] text-gray-500 mb-2">長按圖片可儲存</p><img id="generated-image" class="w-full rounded-lg shadow-md mb-3" src="" alt="行程圖"><a id="download-link" href="#" download="trip_plan.png" class="inline-block w-full bg-stone-700 text-white py-2 rounded-lg text-sm">下載圖片</a></div></div></div>
        <div id="toast" class="toast"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getFirestore, doc, onSnapshot, setDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';

        // --- ROBUST FIREBASE INIT ---
        let app, auth, db, appId, firebaseConfig;
        let isOfflineOnly = false;
        let currentUser = null;
        let currentTripId = localStorage.getItem('currentTripId') || 'TRIP-' + Math.floor(1000 + Math.random() * 9000);
        let unsubscribeSnapshot = null;
        // Optimization: Weather Cache
        let weatherCache = { data: null, timestamp: 0 };
        // Optimization: DOM Cache
        let UI = {};

        // ↓↓↓ 請將您的 Firebase 設定貼在下方 ↓↓↓
        const myFirebaseConfig = {
            apiKey: "AIzaSyByoGa9zSiiOMMSUehtJxY6NfbAZ-p2id0",
            authDomain: "japantrip2026-8485f.firebaseapp.com",
            projectId: "japantrip2026-8485f",
            storageBucket: "japantrip2026-8485f.firebasestorage.app",
            messagingSenderId: "449779505780",
            appId: "1:449779505780:web:ac1e285e6b3d185d2b4f21",
            measurementId: "G-3XHQ301Z4J"
        };
        // ↑↑↑

        try {
            if (Object.keys(myFirebaseConfig).length > 0) {
                firebaseConfig = myFirebaseConfig;
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                appId = 'japan-trip-helper';
            } else if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'japan-trip-helper';
            } else {
                throw new Error("Local file detected");
            }
        } catch (e) {
            console.warn("Running in OFFLINE MODE.");
            isOfflineOnly = true;
            if(document.getElementById('sync-status')) document.getElementById('sync-status').innerText = "離線模式";
        }

        // --- DATA MODELS ---
        let sharedData = {
            tripData: [{ day: "第一天", date: "1/11", title: "抵達東京", events: [] }],
            guideData: [],
            flightData: { 
                outbound: { dep: "TPE", depTime: "02:30", arr: "NRT", arrTime: "06:35", num: "捷星 GK12" },
                inbound: { dep: "NRT", depTime: "--:--", arr: "TPE", arrTime: "--:--", num: "--" }
            },
            appSettings: { title: "東京旅遊", date: "2026.01.11 - 01.18" }
        };
        let localData = { checklist: [], expenses: [], memo: "" };
        let currentPlanDayIndex = 0; 
        
        const storedShared = localStorage.getItem('sharedDataBackup');
        if(storedShared) sharedData = JSON.parse(storedShared);
        
        const storedLocal = localStorage.getItem('localUserData');
        if (storedLocal) { localData = JSON.parse(storedLocal); }
        else {
             localData.checklist = [{ text: "護照", checked: false }, { text: "日幣", checked: false }, { text: "信用卡", checked: false }, { text: "網卡", checked: false }];
        }

        const knownLocations = {
            "淺草寺": { type: "spot", desc: "東京都內最古老的寺廟，供奉聖觀音。", tip: "求籤如果是「凶」，請將籤詩綁在架子上化解；若是吉，可以帶回家。" },
            "雷門": { type: "spot", desc: "淺草寺的表參道入口，巨大的紅色燈籠是其標誌。", tip: "燈籠底部有龍的雕刻，記得抬頭看看。" },
            "豪德寺": { type: "spot", desc: "位於東京世田谷區，傳說是招財貓的發源地，供奉成千上萬隻招福貓。", tip: "這裡的貓是「招福貓」，舉右手且手中無金幣。" },
            "仲見世商店街": { type: "shopping", desc: "連接雷門與淺草寺的熱鬧商店街，充滿傳統點心與紀念品。", tip: "推薦嘗試「炸饅頭 (あげまんじゅう)」和「人形燒」，記得在店門口吃完，不要邊走邊吃。" },
            "淺草鰻魚鐵": { type: "food", desc: "知名的鰻魚飯專賣店，以名古屋風味的「鰻魚三吃 (Hitsumabushi)」聞名。", tip: "第一碗吃原味，第二碗加佐料，第三碗加高湯變成茶泡飯。" },
            "小網神社": { type: "spot", desc: "位於日本橋，以「強運厄除」與「洗錢弁財天」聞名，是東京最強財運神社之一。", tip: "記得將硬幣放入竹籃在「錢洗井」中清洗，洗過的錢要放在錢包裡當錢母。" },
            "Qu'il fait bon": { type: "food", desc: "人氣極高的水果塔專賣店，使用大量當季新鮮水果。", tip: "晴空塔店通常大排長龍，建議先去抽號碼牌或避開下午茶尖峰。" },
            "EKIMISE Asakusa": { type: "shopping", desc: "與淺草車站直結的百貨公司，頂樓有展望台。", tip: "頂樓的「哈雷露陽台」是拍攝晴空塔的絕佳免費景點。" },
            "松屋淺草": { type: "shopping", desc: "東京最古老的百貨公司之一，外觀保留了昭和初期的復古風貌。", tip: "地下街的伴手禮區非常豐富，適合回程前採購。" },
            "3COINS": { type: "shopping", desc: "知名 300 日圓雜貨店，商品設計感強且實用。", tip: "與動漫或品牌的聯名商品通常上架就會被搶光，看到喜歡的不要猶豫。" },
            "ROX": { type: "shopping", query: "淺草 ROX", desc: "淺草的大型購物娛樂中心，內有超市、溫泉設施。", tip: "B1 的超市 24 小時營業，很適合買宵夜或水果。" },
            "東京鐵塔": { type: "spot", desc: "東京的經典象徵，紅白相間的電波塔，建於1958年。", tip: "鐵塔的燈光顏色會隨季節變化：夏季是涼爽的白色，冬季是溫暖的橘色。" },
            "東京晴空塔": { type: "spot", desc: "世界最高的自立式電波塔 (634m)，位於押上。", tip: "底下的「索拉町 (Solamachi)」購物中心非常好逛，比登塔還容易花時間。" },
            "澀谷十字路口": { type: "spot", desc: "世界上最繁忙的十字路口，綠燈時一次可有3000人同時穿越。", tip: "最佳俯瞰拍攝點在 MAGNET by SHIBUYA109 的頂樓展望台。" },
            "明治神宮": { type: "spot", desc: "供奉明治天皇與昭憲皇太后，擁有佔地廣大的都市森林。", tip: "入口處巨大的木造「大鳥居」，使用的檜木其實是來自台灣的丹大山與阿里山。" },
            "築地場外市場": { type: "food", desc: "雖然場內市場已搬遷，但場外市場仍是美食天堂，充滿玉子燒與海鮮。", tip: "大部分店家在下午 2:00 後就會打烊，建議安排在上午前往。" },
            "銀座": { type: "shopping", desc: "東京最繁華的高級購物區，匯集了世界頂級名牌旗艦店。", tip: "週末下午中央通會變成「步行者天國」（封街），走在大馬路中間拍照是經典體驗。" },
            "秋葉原": { type: "shopping", desc: "御宅族聖地，動漫、遊戲、電器街的代名詞。", tip: "若想體驗女僕咖啡廳，建議直接進店，不要隨意跟路邊拉客的女僕拍照。" },
            "東京迪士尼樂園": { type: "ticket", desc: "夢想與魔法的王國，擁有灰姑娘城堡的經典園區。", tip: "遊行開始前一小時就要佔位子；善用 App 抽取 DPA (付費快速通關)。" },
            "東京迪士尼海洋": { type: "ticket", desc: "全球唯一的海洋主題迪士尼，氣氛較成熟浪漫。", tip: "達菲熊 (Duffy) 相關商品是海洋限定，樂園那邊買不到喔。" }
        };

        let editingEventState = null;

        // --- AUTH & SYNC ---
        const initAuth = async () => {
            if (isOfflineOnly) return;
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(auth, __initial_auth_token); } 
                else { await signInAnonymously(auth); }
            } catch (error) { 
                console.error("Auth Error", error); 
                isOfflineOnly = true; 
                document.getElementById('sync-status').innerText = "離線模式";
            }
        };
        
        if (!isOfflineOnly && auth) {
            onAuthStateChanged(auth, (user) => { if (user) { currentUser = user; initSync(); } });
        }

        function initSync() {
            if (isOfflineOnly) return;
            document.getElementById('current-trip-id').innerText = currentTripId;
            localStorage.setItem('currentTripId', currentTripId);
            if (unsubscribeSnapshot) unsubscribeSnapshot();
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'trips', currentTripId);
            unsubscribeSnapshot = onSnapshot(docRef, (docSnap) => {
                const statusEl = document.getElementById('sync-status');
                if (docSnap.exists()) {
                    const remoteData = docSnap.data();
                    if(remoteData.tripData) sharedData.tripData = remoteData.tripData;
                    if(remoteData.guideData) sharedData.guideData = remoteData.guideData;
                    if(remoteData.flightData) sharedData.flightData = remoteData.flightData;
                    if(remoteData.appSettings) sharedData.appSettings = remoteData.appSettings;
                    localStorage.setItem('sharedDataBackup', JSON.stringify(sharedData));
                    renderSharedUI();
                    statusEl.innerText = "已同步"; statusEl.className = "text-[10px] text-green-600 font-bold bg-green-100 px-2 py-0.5 rounded-full";
                } else {
                    saveShared(); statusEl.innerText = "新旅程";
                }
            }, (error) => { console.error("Sync Error:", error); isOfflineOnly = true; document.getElementById('sync-status').innerText = "離線模式 (權限不足)"; });
        }

        function saveLocal() { localStorage.setItem('localUserData', JSON.stringify(localData)); }
        async function saveShared() {
            localStorage.setItem('sharedDataBackup', JSON.stringify(sharedData));
            if (isOfflineOnly || !currentUser) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'trips', currentTripId);
            try { await setDoc(docRef, sharedData); document.getElementById('sync-status').innerText = "儲存中..."; setTimeout(() => document.getElementById('sync-status').innerText = "已同步", 500); } 
            catch (e) { console.error("Save Error", e); if(e.code === 'permission-denied') { isOfflineOnly = true; document.getElementById('sync-status').innerText = "離線模式 (儲存失敗)"; } }
        }

        // --- HELPER FUNCTIONS ---
        window.showToast = (msg) => {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.classList.add('active');
            setTimeout(() => toast.classList.remove('active'), 2500);
        };

        // NEW: Copy Day Text
        window.copyDayText = (dayIndex) => {
            const day = sharedData.tripData[dayIndex];
            if (!day || !day.events.length) {
                showToast("無行程可複製");
                return;
            }
            
            let text = `【${day.date} ${day.title}】\n`;
            // Sort events by time
            const sortedEvents = [...day.events].sort((a,b) => a.time.localeCompare(b.time));
            
            sortedEvents.forEach(e => {
                const typeIcon = {spot:'📍', food:'🍜', transport:'🚇', shopping:'🛍️', hotel:'🏨'}[e.type] || '•';
                text += `${e.time} ${typeIcon} ${e.text}\n`;
                if(e.link) text += `   (地圖: ${e.link})\n`;
            });
            
            navigator.clipboard.writeText(text).then(() => showToast("文字已複製"));
        };

        window.showConfirm = (msg, callback) => {
            document.getElementById('confirm-message').innerText = msg;
            const modal = document.getElementById('confirm-modal');
            modal.classList.add('active');
            const btn = document.getElementById('confirm-btn');
            btn.onclick = () => {
                callback();
                modal.classList.remove('active');
            };
        };
        
        window.showEditDayModal = (currentDate, currentTitle, callback) => {
            document.getElementById('edit-day-date').value = currentDate;
            document.getElementById('edit-day-title').value = currentTitle;
            const modal = document.getElementById('edit-day-modal');
            modal.classList.add('active');
            document.getElementById('save-day-btn').onclick = () => {
                callback(document.getElementById('edit-day-date').value, document.getElementById('edit-day-title').value);
                modal.classList.remove('active');
            }
        };

        // NEW: Open Move Day Modal
        window.openMoveDayModal = (currentIndex) => {
            const select = document.getElementById('move-day-select');
            select.innerHTML = '';
            sharedData.tripData.forEach((d, i) => {
                const option = document.createElement('option');
                option.value = i;
                option.text = `移動到：第 ${i + 1} 天 (${d.date})`;
                if(i === currentIndex) {
                    option.text += " (目前)";
                    option.disabled = true; // Cannot move to self
                }
                select.appendChild(option);
            });
            
            // Set save handler
            document.getElementById('save-move-day-btn').onclick = () => {
                const targetIndex = parseInt(select.value);
                if (!isNaN(targetIndex)) {
                    window.moveDay(currentIndex, targetIndex);
                }
                closeModal('move-day-modal');
            };
            
            document.getElementById('move-day-modal').classList.add('active');
        };

        // NEW: Move Day Logic
        window.moveDay = (fromIndex, toIndex) => {
            if(fromIndex === toIndex) return;
            
            // Move item in array
            const item = sharedData.tripData.splice(fromIndex, 1)[0];
            sharedData.tripData.splice(toIndex, 0, item);
            
            // Renumber days to keep sequence correct (Day 1, Day 2...)
            sharedData.tripData.forEach((d, i) => {
                d.day = `第${i+1}天`;
            });
            
            // Switch view to the new position of the moved day
            currentPlanDayIndex = toIndex;
            
            saveShared();
            renderPlan();
            showToast("天數已移動");
        };

        // --- RENDER LOGIC ---
        function renderPlan() {
            const daySelector = document.getElementById('day-selector');
            daySelector.innerHTML = '';
            sharedData.tripData.forEach((d, i) => {
                const btn = document.createElement('button');
                btn.className = `flex-shrink-0 px-4 py-2 rounded-full text-xs font-bold transition ${i === currentPlanDayIndex ? 'bg-stone-700 text-white dark:bg-stone-100 dark:text-stone-800' : 'bg-white dark:bg-stone-800 text-stone-500 dark:text-stone-400 border border-stone-200 dark:border-stone-700'}`;
                btn.innerText = d.day;
                btn.onclick = () => window.switchPlanDay(i);
                daySelector.appendChild(btn);
            });
            const addBtn = document.createElement('button');
            addBtn.className = "flex-shrink-0 px-3 py-2 rounded-full text-xs font-bold bg-stone-200 text-stone-600 dark:bg-stone-700 dark:text-stone-300";
            addBtn.innerHTML = '<i class="fa-solid fa-plus"></i>';
            addBtn.onclick = window.addNewDay;
            daySelector.appendChild(addBtn);

            const dayOptions = sharedData.tripData.map((d, i) => `<option value="${i}">${d.day} - ${d.date}</option>`).join('');
            document.getElementById('plan-day-select').innerHTML = dayOptions;
            document.getElementById('edit-plan-day').innerHTML = dayOptions;

            const container = document.getElementById('itinerary-container');
            container.innerHTML = '';
            
            if (sharedData.tripData.length > 0) {
                const day = sharedData.tripData[currentPlanDayIndex];
                
                const headerHtml = `
                    <div class="flex justify-between items-end mb-4 border-l-4 border-stone-400 pl-3">
                        <div>
                            <h2 class="text-2xl font-serif font-bold text-muji-text dark:text-stone-100">${day.date}</h2>
                            <p class="text-sm text-stone-500 dark:text-stone-400">${day.title}</p>
                        </div>
                        <div class="flex gap-2">
                             <!-- Copy Text Button -->
                             <button onclick="copyDayText(${currentPlanDayIndex})" class="text-stone-300 hover:text-stone-500 dark:hover:text-stone-200" title="複製文字"><i class="fa-regular fa-copy"></i></button>
                             <button onclick="openMoveDayModal(${currentPlanDayIndex})" class="text-stone-300 hover:text-stone-500 dark:hover:text-stone-200" title="移動此天"><i class="fa-solid fa-arrow-right-arrow-left"></i></button>
                             <button onclick="editDayHeader(${currentPlanDayIndex})" class="text-stone-300 hover:text-stone-500 dark:hover:text-stone-200"><i class="fa-solid fa-pen"></i></button>
                             <button onclick="exportDayImage()" class="text-stone-300 hover:text-stone-500 dark:hover:text-stone-200"><i class="fa-solid fa-image"></i></button>
                             <button onclick="deleteDay(${currentPlanDayIndex})" class="text-stone-300 hover:text-red-400"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                `;
                container.innerHTML = headerHtml;

                const events = day.events.sort((a,b) => a.time.localeCompare(b.time));
                
                // Get current time for highlighting
                const now = new Date();
                const currentHHMM = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                
                if (events.length === 0) {
                    container.innerHTML += `<div onclick="openAddPlanModal()" class="border-2 border-dashed border-stone-300 dark:border-stone-700 rounded-xl p-8 text-center text-stone-400 cursor-pointer hover:bg-stone-100 dark:hover:bg-stone-800 transition"><i class="fa-regular fa-calendar-plus text-2xl mb-2"></i><div class="text-xs">點擊新增行程</div></div>`;
                } else {
                    let html = '<div class="relative border-l border-stone-200 dark:border-stone-700 ml-3 space-y-6 pb-4">';
                    
                    // Find next event index
                    let nextEventId = null;
                    // Only highlight if viewing "today" or generally (logic simplified to highlight next based on time regardless of date for demo, or match date)
                    // For simplicity, we just highlight the first event that is after current time
                    for(let evt of events) {
                         if (evt.time > currentHHMM) {
                             nextEventId = evt.id;
                             break;
                         }
                    }

                    events.forEach(evt => {
                        const iconMap = { spot: 'fa-map-pin', food: 'fa-utensils', transport: 'fa-train-subway', shopping: 'fa-bag-shopping', hotel: 'fa-bed' };
                        const icon = iconMap[evt.type] || 'fa-circle';
                        
                        let cardClass = evt.important ? 'border-amber-400 bg-amber-50 dark:bg-amber-900/20' : 'border-stone-100 dark:border-stone-700 bg-white dark:bg-stone-800';
                        let glowEffect = '';
                        let nextBadge = '';

                        // Highlight logic
                        if (evt.id === nextEventId) {
                            cardClass = 'border-blue-400 bg-blue-50 dark:bg-blue-900/20 ring-2 ring-blue-200 dark:ring-blue-900';
                            glowEffect = 'animate-pulse'; // Soft pulse
                            nextBadge = `<span class="absolute -top-2 right-2 bg-blue-500 text-white text-[10px] px-2 py-0.5 rounded-full z-10">Next</span>`;
                        }
                        
                        html += `
                            <div class="relative pl-6 group">
                                <div class="absolute -left-[9px] top-1 bg-muji-base dark:bg-stone-900 p-1 rounded-full text-stone-400 text-xs"><i class="fa-solid ${icon}"></i></div>
                                <div class="relative flex items-start justify-between ${cardClass} p-3 rounded-lg shadow-sm border transition-all active:scale-[0.99]" onclick="editPlanEvent(${currentPlanDayIndex}, '${evt.id}')">
                                    ${nextBadge}
                                    <div class="flex-1">
                                        <div class="flex items-baseline gap-2 mb-1">
                                            <span class="font-mono font-bold text-muji-primary dark:text-stone-400 text-lg ${glowEffect}">${evt.time}</span>
                                            ${evt.link ? `<a href="${evt.link}" target="_blank" onclick="event.stopPropagation()" class="text-stone-300 hover:text-blue-400"><i class="fa-solid fa-location-dot"></i></a>` : ''}
                                        </div>
                                        <div class="text-muji-text dark:text-stone-200 font-medium">${evt.text}</div>
                                    </div>
                                    <button onclick="event.stopPropagation(); deletePlanEvent(${currentPlanDayIndex}, '${evt.id}')" class="text-stone-200 hover:text-red-400 p-2"><i class="fa-solid fa-xmark"></i></button>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    html += `<button onclick="openAddPlanModal()" class="w-full py-3 text-stone-400 text-xs font-bold border-t border-stone-200 dark:border-stone-700 hover:bg-stone-100 dark:hover:bg-stone-800 transition"><i class="fa-solid fa-plus mr-1"></i> 新增行程</button>`;
                    container.innerHTML += html;
                }
            } else {
                container.innerHTML = '<div class="text-center py-10 text-stone-400">尚無行程，請點擊上方 + 新增天數</div>';
            }
        }
        
        function renderGuide() {
            const container = document.getElementById('guide-container');
            container.innerHTML = '';
            
            const autoSpots = new Set();
            sharedData.tripData.forEach(day => {
                day.events.forEach(e => {
                    if (knownLocations[e.text] || e.type === 'spot') {
                        autoSpots.add(e.text);
                    }
                });
            });

            const manualGuides = sharedData.guideData || [];
            let html = '';
            manualGuides.forEach(g => {
                html += `
                    <div class="bg-white dark:bg-stone-800 p-5 rounded-xl shadow-sm border border-stone-100 dark:border-stone-700 mb-4" onclick="openEditGuideModal('${g.title}', '${g.desc}', '${g.tip || ''}')">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-lg text-muji-text dark:text-stone-200">${g.title}</h3>
                            <span class="text-[10px] bg-stone-100 dark:bg-stone-700 text-stone-500 px-2 py-0.5 rounded">手動</span>
                        </div>
                        <p class="text-sm text-stone-600 dark:text-stone-400 mb-3 line-clamp-3">${g.desc}</p>
                        ${g.tip ? `<div class="bg-yellow-50 dark:bg-yellow-900/20 p-2 rounded text-xs text-stone-600 dark:text-stone-300"><i class="fa-regular fa-lightbulb text-yellow-500 mr-1"></i>${g.tip}</div>` : ''}
                    </div>
                `;
            });

            const iconMap = { spot: 'fa-map-pin', food: 'fa-utensils', transport: 'fa-train-subway', shopping: 'fa-bag-shopping', ticket: 'fa-ticket', hotel: 'fa-bed' };
            
            autoSpots.forEach(spotName => {
                if (manualGuides.some(g => g.title === spotName)) return;
                const info = knownLocations[spotName] || { desc: "尚無詳細介紹", tip: "", type: "spot" };
                const icon = iconMap[info.type] || 'fa-map-pin';
                
                html += `
                    <div class="bg-muji-base dark:bg-stone-900 p-5 rounded-xl border border-stone-200 dark:border-stone-700 mb-4 opacity-80">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-lg text-muji-text dark:text-stone-200 flex items-center gap-2">
                                <i class="fa-solid ${icon} text-sm text-stone-400"></i> ${spotName}
                            </h3>
                            <span class="text-[10px] border border-stone-300 text-stone-400 px-2 py-0.5 rounded">自動偵測</span>
                        </div>
                        <p class="text-sm text-stone-600 dark:text-stone-400 mb-3">${info.desc}</p>
                        ${info.tip ? `<div class="bg-yellow-50 dark:bg-yellow-900/20 p-2 rounded text-xs text-stone-600 dark:text-stone-300 mb-3"><i class="fa-regular fa-lightbulb text-yellow-500 mr-1"></i>${info.tip}</div>` : ''}
                        <button onclick="openEditGuideModal('${spotName}', '${info.desc}', '${info.tip || ''}', '${info.query || ''}')" class="text-xs text-blue-500 underline">編輯 / Google 介紹</button>
                    </div>
                `;
            });

            if (!html) html = '<div class="text-center text-stone-400 text-xs py-10">尚無導覽資料</div>';
            container.innerHTML = html;
        }

        // Explicitly defined before renderLocalUI to fix ReferenceError
        function renderChecklist() {
            const list = document.getElementById('checklist-container');
            const items = localData.checklist || [];
            const done = items.filter(i => i.checked).length;
            document.getElementById('checklist-progress').innerText = `${done}/${items.length}`;
            
            list.innerHTML = items.map((item, i) => `
                <li class="flex items-center justify-between group">
                    <label class="flex items-center gap-3 cursor-pointer flex-1">
                        <input type="checkbox" class="muji-checkbox w-5 h-5 rounded text-stone-600 focus:ring-stone-500 border-stone-300" ${item.checked ? 'checked' : ''} onchange="toggleCheck(${i})">
                        <span class="text-sm ${item.checked ? 'text-stone-400 line-through' : 'text-stone-700 dark:text-stone-200'}">${item.text}</span>
                    </label>
                    <button onclick="deleteChecklistItem(${i})" class="text-stone-200 hover:text-red-400 px-2"><i class="fa-solid fa-xmark"></i></button>
                </li>
            `).join('');
        }

        function initFlightInfo() {
            const d = sharedData.flightData || {};
            const out = d.outbound || {};
            const inc = d.inbound || {};
            
            document.getElementById('disp-out-dep').innerText = out.dep || 'TPE';
            document.getElementById('disp-out-dep-time').innerText = out.depTime || '--:--';
            document.getElementById('disp-out-arr').innerText = out.arr || 'NRT';
            document.getElementById('disp-out-arr-time').innerText = out.arrTime || '--:--';
            document.getElementById('disp-out-flight').innerText = out.num || 'GK12';

            document.getElementById('disp-in-dep').innerText = inc.dep || 'NRT';
            document.getElementById('disp-in-dep-time').innerText = inc.depTime || '--:--';
            document.getElementById('disp-in-arr').innerText = inc.arr || 'TPE';
            document.getElementById('disp-in-arr-time').innerText = inc.arrTime || '--:--';
            document.getElementById('disp-in-flight').innerText = inc.num || '--';
            
            document.getElementById('edit-out-dep').value = out.dep || 'TPE';
            document.getElementById('edit-out-dep-time').value = out.depTime || '';
            document.getElementById('edit-out-arr').value = out.arr || 'NRT';
            document.getElementById('edit-out-arr-time').value = out.arrTime || '';
            document.getElementById('edit-out-num').value = out.num || '';
            
            document.getElementById('edit-in-dep').value = inc.dep || 'NRT';
            document.getElementById('edit-in-dep-time').value = inc.depTime || '';
            document.getElementById('edit-in-arr').value = inc.arr || 'TPE';
            document.getElementById('edit-in-arr-time').value = inc.arrTime || '';
            document.getElementById('edit-in-num').value = inc.num || '';
        }
        
        window.updateWeather = function(force = false) {
            const tempEl = document.getElementById('weather-temp-val');
            const descEl = document.getElementById('weather-desc');
            const iconEl = document.getElementById('weather-icon-main');
            
            // Optimization: Use cached weather data if < 10 mins old
            if (!force && weatherCache.data && (Date.now() - weatherCache.timestamp < 600000)) {
                renderWeatherData(weatherCache.data, tempEl, descEl, iconEl);
                return;
            }

            tempEl.innerText = "--°";
            tempEl.classList.add('animate-pulse');
            descEl.innerText = "定位中...";

            const fetchWeather = async (lat, lon, label) => {
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=auto`);
                    const data = await res.json();
                    if(data.current_weather) {
                        const weatherData = {
                            t: Math.round(data.current_weather.temperature),
                            code: data.current_weather.weathercode,
                            label: label
                        };
                        // Cache result
                        weatherCache = { data: weatherData, timestamp: Date.now() };
                        renderWeatherData(weatherData, tempEl, descEl, iconEl);
                    }
                } catch(e) {
                    console.error(e);
                    descEl.innerText = "資料錯誤";
                } finally {
                    tempEl.classList.remove('animate-pulse');
                }
            };

            if (!navigator.geolocation) {
                fetchWeather(35.6895, 139.6917, "東京"); 
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    fetchWeather(position.coords.latitude, position.coords.longitude, "現地");
                }, 
                (error) => {
                    fetchWeather(35.6895, 139.6917, "東京 (預設)");
                }, 
                { timeout: 5000, enableHighAccuracy: false }
            );
        };

        function renderWeatherData(data, tempEl, descEl, iconEl) {
            tempEl.innerText = `${data.t}°`;
            descEl.innerText = `${data.label} ${getWmoDesc(data.code)}`;
            
            const code = data.code;
            if(code <= 3) iconEl.className = "fa-solid fa-cloud-sun text-2xl text-yellow-500";
            else if(code <= 48) iconEl.className = "fa-solid fa-smog text-2xl text-stone-400";
            else if(code <= 67) iconEl.className = "fa-solid fa-cloud-rain text-2xl text-blue-400";
            else if(code <= 82) iconEl.className = "fa-solid fa-snowflake text-2xl text-cyan-300";
            else iconEl.className = "fa-solid fa-bolt text-2xl text-yellow-600";
        }

        function getWmoDesc(code) {
            const wmo = {
                0: '晴朗', 1: '多雲', 2: '陰天', 3: '陰天',
                45: '霧', 48: '霧凇',
                51: '毛毛雨', 53: '毛毛雨', 55: '毛毛雨',
                61: '小雨', 63: '中雨', 65: '大雨',
                71: '小雪', 73: '中雪', 75: '大雪',
                80: '陣雨', 81: '陣雨', 82: '暴雨',
                95: '雷雨', 96: '雷冰雹', 99: '雷冰雹'
            };
            return wmo[code] || '未知';
        }

        function renderAppSettings() {
            const s = sharedData.appSettings || {};
            document.getElementById('app-title').innerText = s.title || "日本旅遊";
            document.getElementById('app-date').innerText = s.date || "";
            document.getElementById('setting-title').value = s.title || "";
            document.getElementById('setting-date').value = s.date || "";
        }

        // --- EXPORTS ---
        window.fetchExchangeRate = async () => {
            const btnIcon = document.querySelector('#rate-refresh-btn i');
            if(btnIcon) btnIcon.classList.add('fa-spin');
            
            try {
                const res = await fetch('https://api.exchangerate-api.com/v4/latest/JPY');
                const data = await res.json();
                const twdRate = data.rates.TWD;
                
                if (twdRate) {
                    const rateInput = document.getElementById('exchange-rate');
                    rateInput.value = twdRate.toFixed(4);
                    
                    // Trigger update logic
                    localData.exchangeRate = twdRate;
                    saveLocal();
                    
                    // Re-run calc
                    const calcIn = document.getElementById('calc-input');
                    if (calcIn && calcIn.oninput) calcIn.oninput();
                    
                    showToast(`已更新匯率: ${twdRate}`);
                } else {
                    throw new Error("查無匯率");
                }
            } catch (e) {
                console.error(e);
                showToast("匯率更新失敗，請檢查網路");
            } finally {
                if(btnIcon) btnIcon.classList.remove('fa-spin');
            }
        };

        window.copyTripId = () => { navigator.clipboard.writeText(currentTripId).then(() => showToast("代碼已複製")); };
        window.joinTrip = () => {
            if(isOfflineOnly) { showToast("離線模式無法加入旅程"); return; }
            const input = document.getElementById('join-trip-input');
            const newId = input.value.trim().toUpperCase();
            if (!newId) return;
            if (confirm(`切換到 [${newId}]？`)) { 
                currentTripId = newId; 
                initSync(); 
                showToast(`已切換`); 
                input.value = ''; 
            }
        };
        window.togglePlanForm = () => {
            const form = document.getElementById('add-plan-form');
            form.classList.toggle('hidden');
            if(!form.classList.contains('hidden')) {
                form.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        };
        window.toggleGuideForm = () => document.getElementById('add-guide-form').classList.toggle('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.remove('active');
        
        window.openAddPlanModal = () => {
            editingEventState = null;
            document.getElementById('plan-form-title').innerText = "新增行程";
            // Default select current day
            document.getElementById('plan-day-select').value = currentPlanDayIndex;
            document.getElementById('plan-text').value = ''; 
            document.getElementById('plan-link').value = '';
            document.getElementById('plan-time').value = '';
            document.getElementById('plan-important').checked = false;
            
            const form = document.getElementById('add-plan-form');
            form.classList.remove('hidden');
            form.scrollIntoView({ behavior: 'smooth', block: 'center' });
        };

        window.editPlanEvent = (dayIndex, eventId) => {
            const day = sharedData.tripData[dayIndex];
            const evt = day.events.find(e => String(e.id) === String(eventId));
            if (!evt) return;
            editingEventState = { dayIndex, eventId };
            
            const modal = document.getElementById('edit-plan-modal');
            document.getElementById('edit-plan-day').value = dayIndex;
            document.getElementById('edit-plan-time').value = evt.time;
            document.getElementById('edit-plan-type').value = evt.type;
            document.getElementById('edit-plan-text').value = evt.text;
            document.getElementById('edit-plan-link').value = evt.link || '';
            document.getElementById('edit-plan-important').checked = evt.important || false;
            modal.classList.add('active');
        };

        window.saveEditedPlanEvent = () => {
            if (!editingEventState) return;
            const newDayIndex = parseInt(document.getElementById('edit-plan-day').value);
            const time = document.getElementById('edit-plan-time').value;
            const type = document.getElementById('edit-plan-type').value;
            const text = document.getElementById('edit-plan-text').value;
            const link = document.getElementById('edit-plan-link').value;
            const important = document.getElementById('edit-plan-important').checked;

            if (!time || !text) { showToast('請輸入內容'); return; }

            const oldDayIdx = editingEventState.dayIndex;
            const oldDay = sharedData.tripData[oldDayIdx];
            const evtId = editingEventState.eventId;
            
            // Remove from old
            oldDay.events = oldDay.events.filter(e => String(e.id) !== String(evtId));
            
            // Add to new
            sharedData.tripData[newDayIndex].events.push({ id: evtId, time, text, type, link, important });
            
            // Switch view if day changed
            if(newDayIndex !== oldDayIdx) currentPlanDayIndex = newDayIndex;

            saveShared();
            window.closeModal('edit-plan-modal');
            renderPlan();
            showToast('行程已更新');
        };

        window.savePlanEvent = () => {
            const dayIndex = parseInt(document.getElementById('plan-day-select').value);
            const time = document.getElementById('plan-time').value;
            const type = document.getElementById('plan-type').value;
            const text = document.getElementById('plan-text').value;
            const link = document.getElementById('plan-link').value;
            const important = document.getElementById('plan-important').checked;
            if (!time || !text) { showToast('請輸入內容'); return; }

            // Add Mode
            sharedData.tripData[dayIndex].events.push({ id: Date.now() + Math.random(), time, text, type, link, important });
            currentPlanDayIndex = dayIndex; // Switch view to new day
            showToast('行程已新增');
            
            saveShared(); document.getElementById('add-plan-form').classList.add('hidden'); renderPlan(); 
        };
        
        window.deletePlanEvent = (dIdx, eId) => { showConfirm('刪除？', () => { sharedData.tripData[dIdx].events = sharedData.tripData[dIdx].events.filter(e => String(e.id) !== String(eId)); saveShared(); renderPlan(); }); };
        
        // Switch Day Logic
        window.switchPlanDay = (index) => {
            currentPlanDayIndex = index;
            renderPlan();
        };

        window.addNewDay = () => { 
            sharedData.tripData.push({ day: `第${sharedData.tripData.length+1}天`, date: "日期待定", title: "自由活動", events: [] }); 
            currentPlanDayIndex = sharedData.tripData.length - 1; // Switch to new day
            saveShared(); 
            renderPlan(); 
        };
        
        window.deleteDay = (idx) => { 
            showConfirm('刪除整天？', () => { 
                sharedData.tripData.splice(idx, 1); 
                // Adjust current index if needed
                if (currentPlanDayIndex >= sharedData.tripData.length) {
                    currentPlanDayIndex = Math.max(0, sharedData.tripData.length - 1);
                }
                saveShared(); 
                renderPlan(); 
            }); 
        };
        
        window.editDayHeader = (idx) => { const d = sharedData.tripData[idx]; showEditDayModal(d.date, d.title, (nD, nT) => { d.date = nD; d.title = nT; saveShared(); renderPlan(); }); };

        window.exportDayImage = () => {
            const activeDay = sharedData.tripData[currentPlanDayIndex];
            if (!activeDay || !activeDay.events || activeDay.events.length === 0) {
                showToast("無行程可匯出");
                return;
            }

            // Create dedicated container for export (Fixed 3:4 Aspect Ratio, Minimalist)
            const exportDiv = document.createElement('div');
            exportDiv.style.cssText = `
                position: fixed; top: -9999px; left: -9999px;
                width: 600px; height: 800px;
                background-color: ${document.documentElement.classList.contains('dark') ? '#1c1917' : '#f4f4f0'};
                color: ${document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#444444'};
                padding: 50px 40px; 
                display: flex; flex-direction: column;
                font-family: 'Noto Sans TC', sans-serif;
                box-sizing: border-box;
            `;

            // Minimalist Header
            let contentHtml = `
                <div class="mb-10 text-center border-b-2 border-stone-300 dark:border-stone-700 pb-6 flex-shrink-0">
                    <h1 class="text-5xl font-serif font-bold mb-3 tracking-wide">${activeDay.date}</h1>
                    <p class="text-2xl opacity-60 font-light tracking-widest uppercase">${activeDay.title}</p>
                </div>
                <div class="flex-1 flex flex-col justify-center space-y-0 relative">
                    <!-- Decor Line -->
                    <div class="absolute left-[3.5rem] top-2 bottom-2 w-px bg-stone-300 dark:bg-stone-700"></div>
            `;

            // Sort events
            const sortedEvents = [...activeDay.events].sort((a, b) => a.time.localeCompare(b.time));
            
            // Auto scale font size based on density
            const isDense = sortedEvents.length > 8;
            const fontSizeTime = isDense ? 'text-lg' : 'text-xl';
            const fontSizeText = isDense ? 'text-xl' : 'text-2xl';
            const gapSize = isDense ? 'mb-6' : 'mb-8';

            sortedEvents.forEach(evt => {
                contentHtml += `
                    <div class="flex items-baseline relative z-10 ${gapSize}">
                        <div class="${fontSizeTime} font-mono font-bold w-14 text-right opacity-50 mr-8">${evt.time}</div>
                        <div class="${fontSizeText} font-medium flex-1 tracking-wide leading-tight">${evt.text}</div>
                    </div>
                `;
            });
            contentHtml += `</div>
                <div class="mt-auto pt-6 flex justify-between items-end opacity-20 flex-shrink-0">
                    <span class="text-xs font-mono tracking-widest">JAPAN TRIP</span>
                    <i class="fa-solid fa-plane text-xl"></i>
                </div>`;

            exportDiv.innerHTML = contentHtml;
            document.body.appendChild(exportDiv);

            setTimeout(() => {
                html2canvas(exportDiv, { 
                    backgroundColor: null,
                    useCORS: true, scale: 2 
                }).then(canvas => {
                    const dataUrl = canvas.toDataURL("image/png");
                    document.getElementById('generated-image').src = dataUrl;
                    document.getElementById('download-link').href = dataUrl;
                    document.getElementById('image-modal').classList.add('active');
                    document.body.removeChild(exportDiv);
                }).catch(err => {
                    console.error(err);
                    showToast("圖片生成失敗");
                    if(document.body.contains(exportDiv)) document.body.removeChild(exportDiv);
                });
            }, 500);
        };

        window.addGuideItem = () => {
            const title = document.getElementById('guide-title').value, desc = document.getElementById('guide-desc').value, tip = document.getElementById('guide-tip').value;
            if(!title) return;
            sharedData.guideData.push({ id: Date.now(), title, desc, tip }); saveShared(); window.toggleGuideForm(); renderGuide();
        };
        
        window.initWallet = () => { 
            loadExpenses(); 
            renderExpenseAnalysis(); 

            // Fix: Add calculator logic binding
            const calcIn = document.getElementById('calc-input');
            const rateIn = document.getElementById('exchange-rate');
            const calcOut = document.getElementById('calc-result-twd');
            const rateRef = document.getElementById('rate-reference');

            // Restore saved rate
            if (localData.exchangeRate) rateIn.value = localData.exchangeRate;

            const updateRateTable = (rate) => {
                const amounts = [1000, 3000, 5000, 10000];
                rateRef.innerHTML = amounts.map(amt => `
                    <div class="text-center">
                        <div class="text-[10px] text-stone-400">¥${(amt/1000).toLocaleString()}k</div>
                        <div class="text-sm font-bold text-stone-200">$${Math.round(amt*rate).toLocaleString()}</div>
                    </div>
                `).join('');
            };
            
            const runCalc = () => {
                try {
                    const val = calcIn.value.replace(/[^0-9+\-*/().]/g, ''); 
                    const rate = parseFloat(rateIn.value) || 0.22;
                    
                    // Always update table
                    updateRateTable(rate);

                    if(!val) { calcOut.innerText = '0'; return; }
                    const jpy = new Function('return ' + val)();
                    calcOut.innerText = Math.round(jpy * rate).toLocaleString();
                } catch(e) {}
            };
            
            calcIn.oninput = runCalc;
            rateIn.oninput = () => { 
                localData.exchangeRate = parseFloat(rateIn.value);
                saveLocal();
                runCalc(); 
                loadExpenses(); 
            }; 
            
            // Run immediately
            runCalc();
        };

        window.addExpense = async () => {
            const name = document.getElementById('expense-name').value;
            const cat = document.getElementById('expense-cat').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            if(!name || !amount) { showToast("請輸入"); return; }
            const fileInput = document.getElementById('expense-photo');
            let photoData = null;
            if(fileInput.files && fileInput.files[0]) { try { photoData = await processImage(fileInput.files[0]); } catch(e){} }
            localData.expenses.unshift({ id: Date.now(), date: new Date().toLocaleString('zh-TW', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'}), name, amount, category: cat, photo: photoData });
            saveLocal(); loadExpenses(); renderExpenseAnalysis(); document.getElementById('expense-name').value = ''; document.getElementById('expense-amount').value = ''; fileInput.value = ''; showToast('已記帳');
        };
        window.deleteExpense = (id) => { showConfirm('刪除？', () => { localData.expenses = localData.expenses.filter(e => String(e.id) !== String(id)); saveLocal(); loadExpenses(); renderExpenseAnalysis(); }); };

        // Export/Import Local Data
        window.exportLocalData = () => {
            const dataStr = JSON.stringify(localData);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `JapanTrip_Backup_${new Date().toISOString().slice(0,10)}.json`;
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        };

        window.importLocalData = (input) => {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if(confirm("確定要還原備份嗎？現有的記帳與清單將被覆蓋。")) {
                        localData = imported;
                        saveLocal();
                        renderLocalUI();
                        showToast("還原成功");
                    }
                } catch(err) { showToast("檔案格式錯誤"); }
            };
            reader.readAsText(file);
        };

        window.addChecklistItem = () => { const val = document.getElementById('new-checklist-item').value; if(val) { localData.checklist.push({text: val, checked: false}); saveLocal(); renderChecklist(); document.getElementById('new-checklist-item').value = ''; } };
        window.toggleCheck = (i) => { localData.checklist[i].checked = !localData.checklist[i].checked; saveLocal(); renderChecklist(); };
        window.deleteChecklistItem = (i) => { showConfirm('刪除？', () => { localData.checklist.splice(i, 1); saveLocal(); renderChecklist(); }); };
        window.initMemo = () => { document.getElementById('memo-area').addEventListener('input', (e) => { localData.memo = e.target.value; clearTimeout(window.saveTimeout); window.saveTimeout = setTimeout(saveLocal, 500); }); document.getElementById('memo-area').value = localData.memo; parseMemoLinks(); };
        
        window.saveAppSettings = () => { sharedData.appSettings = { title: document.getElementById('setting-title').value, date: document.getElementById('setting-date').value }; saveShared(); renderAppSettings(); showToast('設定已儲存'); };
        window.saveFlightInfo = () => { sharedData.flightData = { 
            outbound: {
                dep: document.getElementById('edit-out-dep').value,
                depTime: document.getElementById('edit-out-dep-time').value,
                arr: document.getElementById('edit-out-arr').value,
                arrTime: document.getElementById('edit-out-arr-time').value,
                num: document.getElementById('edit-out-num').value
            },
            inbound: {
                dep: document.getElementById('edit-in-dep').value,
                depTime: document.getElementById('edit-in-dep-time').value,
                arr: document.getElementById('edit-in-arr').value,
                arrTime: document.getElementById('edit-in-arr-time').value,
                num: document.getElementById('edit-in-num').value
            }
        }; saveShared(); closeModal('edit-flight-modal'); initFlightInfo(); showToast('航班已更新'); };
        window.openEditGuideModal = (t, d, tip, q) => { document.getElementById('edit-guide-title').value = t; document.getElementById('edit-guide-desc').value = d; document.getElementById('edit-guide-tip').value = tip; document.getElementById('edit-guide-search').href = `https://www.google.com/search?q=${encodeURIComponent(q || t + " 介紹")}`; document.getElementById('edit-guide-modal').classList.add('active'); };
        window.openFlightModal = () => { const d = sharedData.flightData || {}; document.getElementById('edit-out-dep').value = d.outbound?.dep || "TPE"; document.getElementById('edit-out-dep-time').value = d.outbound?.depTime || ""; document.getElementById('edit-out-arr').value = d.outbound?.arr || "NRT"; document.getElementById('edit-out-arr-time').value = d.outbound?.arrTime || ""; document.getElementById('edit-out-num').value = d.outbound?.num || ""; document.getElementById('edit-in-dep').value = d.inbound?.dep || "NRT"; document.getElementById('edit-in-dep-time').value = d.inbound?.depTime || ""; document.getElementById('edit-in-arr').value = d.inbound?.arr || "TPE"; document.getElementById('edit-in-arr-time').value = d.inbound?.arrTime || ""; document.getElementById('edit-in-num').value = d.inbound?.num || ""; document.getElementById('edit-flight-modal').classList.add('active'); };
        window.clearAllData = () => { showConfirm("重置所有？", async () => { sharedData = { tripData: [], guideData: [], flightData: {}, appSettings: {} }; localData = { expenses: [], checklist: [], memo: "" }; await saveShared(); saveLocal(); location.reload(); }); };
        window.switchTab = (tabId) => { document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active')); document.getElementById(`tab-${tabId}`).classList.add('active'); document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active')); document.querySelector(`.nav-btn[data-target="${tabId}"]`).classList.add('active'); window.scrollTo(0,0); localStorage.setItem('activeTab', tabId); if(tabId === 'guide') renderGuide(); };
        window.toggleDarkMode = () => { const isDark = document.documentElement.classList.toggle('dark'); localStorage.setItem('darkMode', isDark); updateDarkModeIcon(isDark); };
        function updateDarkModeIcon(isDark) { const i = document.getElementById('dark-mode-icon'); if(isDark) { i.className = 'fa-solid fa-sun text-lg'; } else { i.className = 'fa-solid fa-moon text-lg'; } }
        function initDarkMode() { const m = localStorage.getItem('darkMode'); if(m !== 'false') document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark'); updateDarkModeIcon(m !== 'false'); }
        window.parseMemoLinks = parseMemoLinks;
        function parseMemoLinks() { const area = document.getElementById('memo-area'); const container = document.getElementById('memo-links'); container.innerHTML = ''; const matches = area.value.match(/(https?:\/\/[^\s]+)/g); if(matches) matches.forEach(url => { const a = document.createElement('a'); a.href = url; a.target = "_blank"; a.className = "inline-flex items-center gap-1 bg-stone-200 dark:bg-stone-700 text-stone-600 dark:text-stone-300 px-3 py-1 rounded-full text-xs max-w-full truncate hover:bg-stone-300 dark:hover:bg-stone-600 transition"; a.innerHTML = `<i class="fa-solid fa-link text-[10px]"></i> 連結`; container.appendChild(a); }); }
        window.viewImage = (b64) => { const win = window.open(""); win.document.write(`<img src="${b64}" style="width:100%; height:auto; background:#333;">`); };
        function processImage(file) { return new Promise((res, rej) => { const r = new FileReader(); r.readAsDataURL(file); r.onload = e => { const img = new Image(); img.src = e.target.result; img.onload = () => { const c = document.createElement('canvas'), MAX = 300; let w = img.width, h = img.height; if (w > h) { if (w > MAX) { h *= MAX / w; w = MAX; } } else { if (h > MAX) { w *= MAX / h; h = MAX; } } c.width = w; c.height = h; c.getContext('2d').drawImage(img, 0, 0, w, h); res(c.toDataURL('image/jpeg', 0.6)); }; img.onerror = rej; }; r.onerror = rej; }); }

        // Render Functions
        function renderSharedUI() { renderPlan(); renderGuide(); renderAppSettings(); initFlightInfo(); updateWeather(); }
        function renderLocalUI() { loadExpenses(); renderExpenseAnalysis(); renderChecklist(); document.getElementById('memo-area').value = localData.memo; parseMemoLinks(); }
        
        function renderExpenseAnalysis() {
            const expenses = localData.expenses || [];
            if(expenses.length === 0) { document.getElementById('expense-analysis').classList.add('hidden'); return; }
            document.getElementById('expense-analysis').classList.remove('hidden');
            const totals = {}; let grandTotal = 0;
            expenses.forEach(e => { const cat = e.category || 'other'; totals[cat] = (totals[cat] || 0) + e.amount; grandTotal += e.amount; });
            const cats = { 'food': '食', 'transport': '行', 'shopping': '購', 'ticket': '樂', 'hotel': '住', 'other': '他' };
            const colors = { 'food': 'bg-red-400', 'transport': 'bg-blue-400', 'shopping': 'bg-purple-400', 'ticket': 'bg-yellow-400', 'hotel': 'bg-green-400', 'other': 'bg-gray-400' };
            let html = '';
            for(const [key, label] of Object.entries(cats)) {
                const val = totals[key] || 0;
                if(val > 0) {
                    const pct = Math.round((val / grandTotal) * 100);
                    html += `<div class="flex items-center text-xs mb-1"><div class="w-8 text-stone-500">${label}</div><div class="flex-1"><div class="flex justify-between mb-1"><span>¥${val.toLocaleString()}</span><span>${pct}%</span></div><div class="progress-bar-bg"><div class="progress-bar-fill ${colors[key]}" style="width:${pct}%"></div></div></div></div>`;
                }
            }
            document.getElementById('expense-bars').innerHTML = html;
        }

        function loadExpenses() {
            const list = document.getElementById('expense-list'); const expenses = localData.expenses || []; const rate = parseFloat(document.getElementById('exchange-rate').value) || 0.22;
            if(expenses.length === 0) { list.innerHTML = '<div class="text-center text-stone-400 text-xs py-4">尚未有記帳紀錄。</div>'; return; }
            let html = ''; let totalJPY = 0;
            const catIcons = { 'food': 'fa-utensils', 'transport': 'fa-train-subway', 'shopping': 'fa-bag-shopping', 'ticket': 'fa-ticket', 'hotel': 'fa-bed', 'other': 'fa-circle-question' };
            const catColors = { 'food': 'text-red-400 bg-red-50 dark:bg-red-900/20', 'transport': 'text-blue-400 bg-blue-50 dark:bg-blue-900/20', 'shopping': 'text-purple-400 bg-purple-50 dark:bg-purple-900/20', 'ticket': 'text-yellow-400 bg-yellow-50 dark:bg-yellow-900/20', 'hotel': 'text-green-400 bg-green-50 dark:bg-green-900/20', 'other': 'text-gray-400 bg-gray-50 dark:bg-gray-900/20' };
            expenses.forEach(ex => {
                totalJPY += ex.amount; const twd = Math.round(ex.amount * rate);
                const cat = ex.category || 'other'; const iconClass = catIcons[cat]; const colorClass = catColors[cat];
                const hasPhoto = ex.photo ? `<img loading="lazy" src="${ex.photo}" class="w-10 h-10 object-cover rounded-lg border border-stone-200 dark:border-stone-600" onclick="viewImage('${ex.photo}')">` : `<div class="w-10 h-10 rounded-lg flex items-center justify-center ${colorClass}"><i class="fa-solid ${iconClass}"></i></div>`;
                html += `<div class="flex items-center gap-3 bg-white dark:bg-stone-800 p-3 rounded-xl shadow-sm border border-stone-50 dark:border-stone-700 transition-colors duration-300">${hasPhoto}<div class="flex-1 min-w-0"><div class="text-sm font-bold text-muji-text dark:text-stone-200 truncate">${ex.name}</div><div class="text-[10px] text-stone-400 dark:text-stone-500">${ex.date}</div></div><div class="text-right"><div class="text-sm font-bold text-muji-text dark:text-stone-200">¥${ex.amount.toLocaleString()}</div><div class="text-[10px] text-stone-400 dark:text-stone-500">≈ NT$${twd.toLocaleString()}</div></div><button onclick="deleteExpense('${ex.id}')" class="text-stone-300 hover:text-red-400 px-2"><i class="fa-solid fa-trash"></i></button></div>`;
            });
            list.innerHTML = `<div class="bg-stone-200 dark:bg-stone-700 p-3 rounded-lg mb-4 text-center transition-colors duration-300"><span class="text-xs text-stone-500 dark:text-stone-400">總計:</span> <span class="font-bold text-stone-700 dark:text-stone-200">¥${totalJPY.toLocaleString()}</span><span class="text-xs text-stone-400 dark:text-stone-500">(~NT$${Math.round(totalJPY * rate).toLocaleString()})</span></div>${html}`;
        }
        
        // --- INIT ---
        initDarkMode();
        renderLocalUI();
        initAuth();
        initWallet(); // Ensure wallet logic runs on startup
        // If offline immediately, render empty shared structure
        if(isOfflineOnly) {
            renderSharedUI();
        }
    </script>
</body>
</html>