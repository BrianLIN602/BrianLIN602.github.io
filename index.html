<!DOCTYPE html>
<html lang="zh-TW" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>日本旅遊小幫手</title>
    
    <!-- PWA / Mobile App Config -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="日本旅遊">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#1c1917">
    <link rel="apple-touch-icon" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/sprites/solid.svg"> 
    
    <!-- Android Manifest -->
    <link rel="manifest" href='data:application/manifest+json,%7B%22name%22%3A%22%E6%97%A5%E6%9C%AC%E6%97%85%E9%81%8A%E5%B0%8F%E5%B9%AB%E6%89%8B%22%2C%22short_name%22%3A%22%E6%97%A5%E6%9C%AC%E6%97%85%E9%81%8A%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%231c1917%22%2C%22theme_color%22%3A%22%231c1917%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22https%3A%2F%2Fcdn-icons-png.flaticon.com%2F512%2F827%2F827056.png%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fpng%22%7D%5D%7D'>

    <!-- Fonts & CSS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        muji: { base: '#f4f4f0', text: '#444444', accent: '#7b7b7b', card: '#ffffff', primary: '#8c8c88', alert: '#bf6a6a' }
                    },
                    fontFamily: { sans: ['"Noto Sans TC"', 'sans-serif'], serif: ['"Noto Serif TC"', 'serif'] }
                }
            }
        }
    </script>

    <style>
        body { background-color: #e5e5e5; font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; transition: background-color 0.3s; overscroll-behavior-y: none; }
        html.dark body { background-color: #111; }
        #app-container { background-color: #f4f4f0; color: #444444; min-height: 100vh; padding-top: env(safe-area-inset-top); padding-bottom: calc(80px + env(safe-area-inset-bottom)); box-shadow: 0 0 20px rgba(0,0,0,0.05); transition: background-color 0.3s, color 0.3s; }
        html.dark #app-container { background-color: #1c1917; color: #e5e7eb; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .muji-checkbox:checked { background-color: #8c8c88; border-color: #8c8c88; }
        .map-container iframe { width: 100%; height: 100%; border-radius: 0.5rem; filter: grayscale(20%); }
        html.dark .map-container iframe { filter: grayscale(20%) invert(90%) hue-rotate(180deg); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; backdrop-filter: blur(2px); }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-box { background: white; width: 85%; max-width: 320px; border-radius: 16px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transform: scale(0.95); transition: transform 0.2s; }
        .modal-overlay.active .modal-box { transform: scale(1); }
        html.dark .modal-box { background: #292524; color: #e5e5e5; border: 1px solid #44403c; }
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(20px); background: rgba(40, 40, 40, 0.9); color: white; padding: 10px 20px; border-radius: 50px; font-size: 13px; opacity: 0; transition: all 0.3s; pointer-events: none; z-index: 3000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .toast.active { opacity: 1; transform: translateX(-50%) translateY(0); }
        html.dark .toast { background: rgba(255, 255, 255, 0.9); color: #1c1917; }
    </style>
</head>
<body>

    <div id="app-container" class="max-w-md mx-auto relative overflow-hidden">
        
        <!-- Header -->
        <header class="bg-muji-base dark:bg-stone-900 sticky top-0 z-50 px-6 py-4 border-b border-stone-200 dark:border-stone-800 flex justify-between items-center bg-opacity-95 backdrop-blur-sm transition-colors duration-300">
            <div>
                <h1 id="app-title" class="font-serif text-xl font-bold text-muji-text dark:text-stone-100 tracking-widest">東京旅遊</h1>
                <p id="app-date" class="text-xs text-muji-accent dark:text-stone-400 mt-0.5">2026.01.11 - 01.18</p>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="toggleDarkMode()" class="text-muji-primary dark:text-stone-400 hover:text-stone-600 dark:hover:text-stone-200 transition p-1">
                    <i id="dark-mode-icon" class="fa-solid fa-moon text-lg"></i>
                </button>
                <a id="weather-link" href="https://www.jma.go.jp/bosai/forecast/" target="_blank" class="flex items-center gap-1 text-muji-primary dark:text-stone-400 hover:text-stone-600 dark:hover:text-stone-200 transition p-1 no-underline">
                    <i id="weather-icon-i" class="fa-solid fa-cloud-sun text-xl"></i>
                    <span id="weather-temp" class="text-xs font-sans font-bold hidden">--°C</span>
                </a>
            </div>
        </header>

        <!-- CONTENT: PLAN -->
        <main class="p-4">
            <div id="tab-plan" class="tab-content active">
                <!-- Flight Card -->
                <div class="bg-muji-card dark:bg-stone-800 p-5 rounded-xl shadow-sm border border-stone-100 dark:border-stone-700 mb-6 transition-colors duration-300 relative group">
                    <button onclick="openFlightModal()" class="absolute top-3 right-3 text-stone-300 hover:text-stone-500 dark:hover:text-stone-300 p-2"><i class="fa-solid fa-pen text-xs"></i></button>
                    <h3 class="text-sm font-bold text-muji-primary dark:text-stone-400 mb-3 uppercase tracking-wide border-b border-stone-100 dark:border-stone-700 pb-2">航班資訊</h3>
                    <div class="flex justify-between items-center mb-2">
                        <div class="text-center">
                            <div id="disp-dep-airport" class="text-2xl font-serif font-bold text-muji-text dark:text-stone-100">TPE</div>
                            <div id="disp-dep-time" class="text-xs text-muji-accent dark:text-stone-400">02:30</div>
                        </div>
                        <div class="flex-1 px-4 text-center">
                            <i class="fa-solid fa-plane text-muji-primary dark:text-stone-500 text-sm"></i>
                            <div class="h-[1px] bg-stone-300 dark:bg-stone-600 w-full mt-1"></div>
                            <div id="disp-flight-num" class="text-[10px] text-muji-accent dark:text-stone-500 mt-1">捷星 GK12</div>
                        </div>
                        <div class="text-center">
                            <div id="disp-arr-airport" class="text-2xl font-serif font-bold text-muji-text dark:text-stone-100">NRT</div>
                            <div id="disp-arr-time" class="text-xs text-muji-accent dark:text-stone-400">06:35</div>
                        </div>
                    </div>
                </div>

                <button onclick="openAddPlanModal()" class="w-full mb-6 border-2 border-dashed border-stone-300 dark:border-stone-700 text-stone-400 dark:text-stone-500 rounded-xl p-3 flex flex-col items-center justify-center hover:bg-stone-50 dark:hover:bg-stone-800 transition group active:scale-95">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-calendar-plus text-lg group-hover:scale-110 transition-transform"></i><span class="text-xs font-bold">新增行程項目</span>
                    </div>
                </button>

                <div id="add-plan-form" class="hidden bg-white dark:bg-stone-800 p-5 rounded-xl shadow-lg border border-stone-100 dark:border-stone-700 mb-6 transition-all duration-300">
                    <h3 id="plan-form-title" class="text-sm font-bold text-muji-primary dark:text-stone-400 mb-3">新增行程</h3>
                    <div class="space-y-3">
                        <div><label class="block text-xs text-stone-500 dark:text-stone-400 mb-1">選擇日期</label><select id="plan-day-select" class="w-full bg-muji-base dark:bg-stone-900 dark:text-white border-none rounded-lg text-sm px-3 py-2"></select></div>
                        <div class="flex gap-2">
                            <div class="w-1/3"><label class="block text-xs text-stone-500 dark:text-stone-400 mb-1">時間</label><input type="time" id="plan-time" class="w-full bg-muji-base dark:bg-stone-900 dark:text-white border-none rounded-lg text-sm px-2 py-2"></div>
                            <div class="w-2/3"><label class="block text-xs text-stone-500 dark:text-stone-400 mb-1">類型</label><select id="plan-type" class="w-full bg-muji-base dark:bg-stone-900 dark:text-white border-none rounded-lg text-sm px-3 py-2"><option value="spot">景點</option><option value="food">美食</option><option value="transport">交通</option><option value="shopping">購物</option><option value="hotel">住宿</option></select></div>
                        </div>
                        <div><label class="block text-xs text-stone-500 dark:text-stone-400 mb-1">行程內容</label><input type="text" id="plan-text" placeholder="例：前往淺草寺參拜" class="w-full bg-muji-base dark:bg-stone-900 dark:text-white border-none rounded-lg text-sm px-3 py-2"></div>
                        <div><label class="block text-xs text-stone-500 dark:text-stone-400 mb-1">Google Maps 連結 (選填)</label><input type="text" id="plan-link" placeholder="貼上地圖網址" class="w-full bg-muji-base dark:bg-stone-900 dark:text-white border-none rounded-lg text-sm px-3 py-2"></div>
                        <div class="flex items-center gap-2"><input type="checkbox" id="plan-important" class="muji-checkbox w-4 h-4 rounded text-amber-500 focus:ring-amber-500"><label for="plan-important" class="text-xs text-stone-600 dark:text-stone-300">標記為重要行程</label></div>
                        <div class="flex gap-2 pt-2"><button onclick="togglePlanForm()" class="flex-1 bg-stone-200 dark:bg-stone-700 text-stone-600 dark:text-stone-300 rounded-lg text-xs py-2">取消</button><button onclick="savePlanEvent()" class="flex-1 bg-stone-700 dark:bg-stone-600 text-white rounded-lg text-xs font-bold py-2">儲存</button></div>
                    </div>
                </div>

                <div id="itinerary-container" class="space-y-6"></div>
                <div class="text-center mt-6 mb-8">
                    <button onclick="addNewDay()" class="text-xs text-stone-400 dark:text-stone-500 hover:text-stone-600 dark:hover:text-stone-300 border border-stone-200 dark:border-stone-700 px-4 py-2 rounded-full transition active:bg-stone-100 dark:active:bg-stone-800"><i class="fa-solid fa-plus mr-1"></i> 新增一天 (Day)</button>
                </div>
            </div>

            <!-- 2. GUIDE -->
            <div id="tab-guide" class="tab-content">
                <div class="mb-6"><h2 class="font-serif text-2xl text-muji-text dark:text-stone-100 mb-2">深度導覽</h2><p class="text-sm text-muji-accent dark:text-stone-400">已自動同步行程中的「景點」。</p></div>
                <button onclick="toggleGuideForm()" class="w-full mb-6 border-2 border-dashed border-stone-300 dark:border-stone-700 text-stone-400 dark:text-stone-500 rounded-xl p-4 flex flex-col items-center justify-center hover:bg-stone-50 dark:hover:bg-stone-800 transition group active:scale-95"><i class="fa-solid fa-plus text-xl mb-1 group-hover:scale-110 transition-transform"></i><span class="text-xs font-bold">手動新增導覽</span></button>
                <div id="add-guide-form" class="hidden bg-white dark:bg-stone-800 p-5 rounded-xl shadow-lg border border-stone-100 dark:border-stone-700 mb-6"><h3 class="text-sm font-bold text-muji-primary dark:text-stone-400 mb-3">撰寫新導覽</h3>
                    <div class="space-y-3"><input type="text" id="guide-title" placeholder="景點名稱" class="w-full bg-muji-base dark:bg-stone-900 dark:text-white border-none rounded-lg text-sm px-3 py-2"><textarea id="guide-desc" rows="4" placeholder="介紹內容..." class="w-full bg-muji-base dark:bg-stone-900 dark:text-white border-none rounded-lg text-sm px-3 py-2 resize-none"></textarea><input type="text" id="guide-tip" placeholder="冷知識 (選填)" class="w-full bg-stone-100 dark:bg-stone-700 dark:text-white border-none rounded-lg text-xs px-3 py-2 text-stone-600 placeholder-stone-400"><div class="flex gap-2 pt-2"><button onclick="toggleGuideForm()" class="flex-1 bg-stone-200 dark:bg-stone-700 text-stone-600 dark:text-stone-300 rounded-lg text-xs py-2">取消</button><button onclick="addGuideItem()" class="flex-1 bg-stone-700 dark:bg-stone-600 text-white rounded-lg text-xs font-bold py-2">新增</button></div></div>
                </div>
                <div id="guide-container"></div>
            </div>

            <!-- 3. WALLET -->
            <div id="tab-wallet" class="tab-content">
                <div class="bg-stone-800 dark:bg-black text-stone-100 p-5 rounded-xl shadow-lg mb-6 relative overflow-hidden transition-colors duration-300">
                    <div class="absolute -right-4 -top-4 text-stone-700 dark:text-stone-800 opacity-20 text-9xl"><i class="fa-solid fa-coins"></i></div>
                    <div class="flex justify-between items-center mb-4"><div class="text-xs text-stone-400" id="rate-status">當前匯率 (日幣/台幣)</div><div class="flex items-center gap-2"><button onclick="initWallet()" class="text-stone-500 hover:text-stone-300 text-xs"><i class="fa-solid fa-rotate-right"></i></button><input type="number" id="exchange-rate" value="0.22" step="0.0001" class="w-20 bg-stone-700 dark:bg-stone-900 border-none rounded text-center text-sm text-white focus:ring-1 focus:ring-stone-500"></div></div>
                    <div class="mb-2"><input type="text" id="calc-input" placeholder="輸入金額 (如 500+200)" class="w-full bg-transparent text-3xl font-mono text-right border-b border-stone-600 focus:outline-none focus:border-stone-400 pb-2 placeholder-stone-600 dark:placeholder-stone-700"></div>
                    <div class="flex justify-end items-end gap-2"><div class="text-stone-400 text-sm">≈ NT$</div><div id="calc-result-twd" class="text-xl font-bold">0</div></div>
                </div>
                <div class="bg-muji-card dark:bg-stone-800 p-5 rounded-xl shadow-sm border border-stone-100 dark:border-stone-700 mb-6 transition-colors duration-300"><h3 class="text-sm font-bold text-muji-primary dark:text-stone-400 mb-4">新增消費 (僅本機儲存)</h3><div class="flex gap-2 mb-3"><input type="text" id="expense-name" placeholder="品項" class="flex-1 bg-muji-base dark:bg-stone-900 dark:text-white border-none rounded-lg text-sm px-3 py-3"><input type="number" id="expense-amount" placeholder="¥" class="w-24 bg-muji-base dark:bg-stone-900 dark:text-white border-none rounded-lg text-sm px-3 py-3"></div><div class="flex gap-2"><label class="flex-1 bg-stone-100 dark:bg-stone-700 text-stone-500 dark:text-stone-300 rounded-lg flex items-center justify-center gap-2 cursor-pointer hover:bg-stone-200 dark:hover:bg-stone-600 transition py-3"><i class="fa-solid fa-camera"></i><span class="text-xs">拍照</span><input type="file" id="expense-photo" accept="image/*" capture="environment" class="hidden"></label><button onclick="addExpense()" class="flex-1 bg-stone-700 dark:bg-stone-600 text-white rounded-lg text-sm font-bold hover:bg-stone-800 dark:hover:bg-stone-500 transition py-3">儲存</button></div><div id="photo-preview-name" class="text-xs text-muji-primary dark:text-stone-400 mt-2 hidden text-center truncate"></div></div>
                <h3 class="text-sm font-bold text-muji-primary dark:text-stone-400 mb-3 px-1">消費紀錄</h3><div id="expense-list" class="space-y-3 pb-20"></div>
            </div>

            <!-- 4. LISTS -->
            <div id="tab-lists" class="tab-content">
                <div class="bg-muji-card dark:bg-stone-800 p-5 rounded-xl shadow-sm border border-stone-100 dark:border-stone-700 mb-6 transition-colors duration-300">
                    <div class="flex justify-between items-center mb-4 border-b border-stone-100 dark:border-stone-700 pb-2"><h3 class="text-sm font-bold text-muji-primary dark:text-stone-400 uppercase">行前準備清單 (僅本機)</h3><span id="checklist-progress" class="text-xs bg-stone-200 dark:bg-stone-700 px-2 py-0.5 rounded text-stone-600 dark:text-stone-300">0/0</span></div>
                    <div class="flex gap-2 mb-4"><input type="text" id="new-checklist-item" placeholder="新增項目..." class="flex-1 bg-muji-base dark:bg-stone-900 dark:text-white border-none rounded-lg text-sm px-3 py-2"><button onclick="addChecklistItem()" class="bg-stone-700 dark:bg-stone-600 text-white rounded-lg px-4 py-2 text-sm"><i class="fa-solid fa-plus"></i></button></div>
                    <ul id="checklist-container" class="space-y-3"></ul>
                </div>
                <div class="bg-muji-card dark:bg-stone-800 p-5 rounded-xl shadow-sm border border-stone-100 dark:border-stone-700 transition-colors duration-300"><h3 class="text-sm font-bold text-muji-primary dark:text-stone-400 mb-3 uppercase">個人備忘錄 (僅本機)</h3><textarea id="memo-area" class="w-full h-40 bg-muji-base dark:bg-stone-900 dark:text-white rounded-lg p-3 text-sm text-muji-text focus:outline-none resize-none leading-relaxed" placeholder="輸入文字..."></textarea><div class="flex justify-between mt-2"><span class="text-[10px] text-muji-accent dark:text-stone-500 pt-1">自動儲存</span><button onclick="parseMemoLinks()" class="text-xs text-stone-500 dark:text-stone-400 underline">更新連結</button></div><div id="memo-links" class="mt-3 flex flex-wrap gap-2"></div></div>
            </div>

            <!-- 5. INFO -->
            <div id="tab-info" class="tab-content">
                <div class="bg-muji-card dark:bg-stone-800 p-5 rounded-xl shadow-sm border border-stone-100 dark:border-stone-700 mb-6 transition-colors duration-300 border-l-4 border-l-amber-400">
                    <h3 class="text-sm font-bold text-muji-primary dark:text-stone-400 mb-3 uppercase border-b border-stone-100 dark:border-stone-700 pb-2 flex justify-between items-center"><span><i class="fa-solid fa-cloud mr-2"></i>旅程同步設定</span><span id="sync-status" class="text-[10px] text-stone-400 font-normal bg-stone-100 dark:bg-stone-700 px-2 py-0.5 rounded-full">檢查中...</span></h3>
                    <div class="space-y-4">
                        <p class="text-[10px] text-stone-400 dark:text-stone-500 leading-relaxed"><i class="fa-solid fa-circle-info mr-1"></i>注意：僅同步「行程、導覽、航班、標題日期」。<br>「記帳、清單、備忘錄」為個人資料，僅儲存於此裝置。</p>
                        <div><label class="block text-xs text-stone-500 dark:text-stone-400 mb-1">旅程代碼 (分享給親友)</label><div class="flex gap-2"><div id="current-trip-id" class="flex-1 bg-stone-100 dark:bg-stone-900 dark:text-white rounded-lg p-3 text-center font-mono font-bold text-lg tracking-wider select-all">...</div><button onclick="copyTripId()" class="bg-stone-200 dark:bg-stone-700 text-stone-600 dark:text-stone-300 px-4 rounded-lg"><i class="fa-regular fa-copy"></i></button></div></div><div><label class="block text-xs text-stone-500 dark:text-stone-400 mb-1">加入其他旅程</label><div class="flex gap-2"><input type="text" id="join-trip-input" placeholder="輸入代碼" class="flex-1 bg-muji-base dark:bg-stone-900 dark:text-white border-none rounded-lg text-sm px-3 py-2 uppercase"><button onclick="joinTrip()" class="bg-stone-700 dark:bg-stone-600 text-white px-4 rounded-lg text-sm font-bold">連線</button></div></div>
                    </div>
                </div>
                <div class="bg-muji-card dark:bg-stone-800 p-5 rounded-xl shadow-sm border border-stone-100 dark:border-stone-700 mb-6"><h3 class="text-sm font-bold text-muji-primary dark:text-stone-400 mb-4 uppercase border-b border-stone-100 dark:border-stone-700 pb-2">旅程設定</h3><div class="space-y-3"><div><label class="block text-xs text-stone-500 dark:text-stone-400 mb-1">標題 (同步)</label><input type="text" id="setting-title" class="w-full bg-muji-base dark:bg-stone-900 dark:text-white border-none rounded-lg text-sm px-3 py-2"></div><div><label class="block text-xs text-stone-500 dark:text-stone-400 mb-1">日期 (同步)</label><input type="text" id="setting-date" class="w-full bg-muji-base dark:bg-stone-900 dark:text-white border-none rounded-lg text-sm px-3 py-2"></div><button onclick="saveShared()" class="w-full bg-stone-700 dark:bg-stone-600 text-white rounded-lg text-sm font-bold py-2 mt-2">儲存設定</button></div></div>
                <div class="grid grid-cols-2 gap-4 mb-6"><a href="https://www.jma.go.jp/jma/index.html" target="_blank" class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-xl text-center border border-blue-100 dark:border-blue-900/30 block"><i class="fa-solid fa-cloud-sun-rain text-2xl text-blue-400 mb-2"></i><div class="text-sm font-bold text-stone-600 dark:text-stone-200">天氣</div></a><a href="https://www.google.com/maps/search/Police+Station" target="_blank" class="bg-red-50 dark:bg-red-900/20 p-4 rounded-xl text-center border border-red-100 dark:border-red-900/30 block"><i class="fa-solid fa-shield-halved text-2xl text-red-400 mb-2"></i><div class="text-sm font-bold text-stone-600 dark:text-stone-200">警察</div></a></div>
                <div class="bg-muji-card dark:bg-stone-800 p-5 rounded-xl shadow-sm border border-stone-100 dark:border-stone-700 mb-6"><h3 class="text-sm font-bold text-muji-primary dark:text-stone-400 mb-3 uppercase border-b border-stone-100 dark:border-stone-700 pb-2">緊急聯絡</h3><div class="space-y-3"><div class="flex justify-between text-sm"><span class="text-muji-text dark:text-stone-200">救護車 / 火警</span><span class="font-bold text-red-500 font-mono">119</span></div><div class="flex justify-between text-sm"><span class="text-muji-text dark:text-stone-200">大阪辦事處</span><span class="font-bold text-muji-text dark:text-stone-200 font-mono">+81-90-8794-4568</span></div></div></div>
                <div class="text-center mt-8 mb-4"><button onclick="clearAllData()" class="text-xs text-red-300 border border-red-100 dark:border-red-900/50 px-3 py-1 rounded">重置本機與雲端資料</button></div>
            </div>
        </main>

        <!-- Navigation & Modals -->
        <nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white dark:bg-stone-900 border-t border-stone-200 dark:border-stone-800 px-2 py-2 flex justify-around items-end z-50 text-[10px] font-medium text-stone-400 pb-safe transition-colors duration-300">
            <button onclick="switchTab('plan')" class="nav-btn active flex flex-col items-center gap-1 p-2 w-1/5 text-muji-primary dark:text-stone-500" data-target="plan"><i class="fa-regular fa-calendar-days text-lg mb-0.5"></i><span>行程</span></button>
            <button onclick="switchTab('guide')" class="nav-btn flex flex-col items-center gap-1 p-2 w-1/5 hover:text-stone-600" data-target="guide"><i class="fa-solid fa-book-open text-lg mb-0.5"></i><span>導覽</span></button>
            <button onclick="switchTab('wallet')" class="nav-btn flex flex-col items-center gap-1 p-2 w-1/5 -mt-6" data-target="wallet"><div class="bg-stone-700 dark:bg-stone-200 text-white dark:text-stone-900 rounded-full w-12 h-12 flex items-center justify-center shadow-lg"><i class="fa-solid fa-wallet text-xl"></i></div><span class="mt-1">錢包</span></button>
            <button onclick="switchTab('lists')" class="nav-btn flex flex-col items-center gap-1 p-2 w-1/5 hover:text-stone-600" data-target="lists"><i class="fa-solid fa-list-check text-lg mb-0.5"></i><span>清單</span></button>
            <button onclick="switchTab('info')" class="nav-btn flex flex-col items-center gap-1 p-2 w-1/5 hover:text-stone-600" data-target="info"><i class="fa-solid fa-circle-info text-lg mb-0.5"></i><span>資訊</span></button>
        </nav>

        <div id="confirm-modal" class="modal-overlay"><div class="modal-box"><h3 class="font-bold text-lg mb-2 dark:text-white">確認</h3><p id="confirm-message" class="text-sm text-gray-500 mb-6 dark:text-gray-400"></p><div class="flex justify-end gap-3"><button onclick="closeModal('confirm-modal')" class="px-4 py-2 text-sm text-gray-500">取消</button><button id="confirm-btn" class="px-4 py-2 text-sm bg-stone-700 text-white rounded">確定</button></div></div></div>
        <div id="edit-day-modal" class="modal-overlay"><div class="modal-box"><h3 class="font-bold text-lg mb-4 dark:text-white">編輯標題</h3><div class="space-y-4 mb-6"><input type="text" id="edit-day-date" class="w-full bg-stone-100 dark:bg-stone-900 dark:text-white p-2 rounded"><input type="text" id="edit-day-title" class="w-full bg-stone-100 dark:bg-stone-900 dark:text-white p-2 rounded"></div><div class="flex justify-end gap-3"><button onclick="closeModal('edit-day-modal')" class="text-sm text-gray-500">取消</button><button id="save-day-btn" class="text-sm bg-stone-700 text-white px-4 py-2 rounded">儲存</button></div></div></div>
        <div id="edit-flight-modal" class="modal-overlay"><div class="modal-box"><h3 class="font-bold text-lg mb-4 dark:text-white">編輯航班</h3><div class="space-y-3 mb-6"><div class="flex gap-2"><input type="text" id="edit-dep-airport" class="w-full bg-stone-100 dark:bg-stone-900 dark:text-white p-2 rounded text-sm"><input type="time" id="edit-dep-time" class="w-full bg-stone-100 dark:bg-stone-900 dark:text-white p-2 rounded text-sm"></div><div class="flex gap-2"><input type="text" id="edit-arr-airport" class="w-full bg-stone-100 dark:bg-stone-900 dark:text-white p-2 rounded text-sm"><input type="time" id="edit-arr-time" class="w-full bg-stone-100 dark:bg-stone-900 dark:text-white p-2 rounded text-sm"></div><input type="text" id="edit-flight-num" class="w-full bg-stone-100 dark:bg-stone-900 dark:text-white p-2 rounded text-sm"></div><div class="flex justify-end gap-3"><button onclick="closeModal('edit-flight-modal')" class="text-sm text-gray-500">取消</button><button onclick="saveFlightInfo()" class="text-sm bg-stone-700 text-white px-4 py-2 rounded">儲存</button></div></div></div>
        <div id="edit-guide-modal" class="modal-overlay"><div class="modal-box"><h3 class="font-bold text-lg mb-4 dark:text-white">編輯介紹</h3><input type="hidden" id="edit-guide-id"><div class="space-y-3 mb-6"><div class="flex gap-2"><input type="text" id="edit-guide-title" class="flex-1 bg-stone-100 dark:bg-stone-900 dark:text-white p-2 rounded text-sm" readonly><a id="edit-guide-search" href="#" target="_blank" class="bg-blue-100 text-blue-600 px-3 rounded flex items-center"><i class="fa-brands fa-google"></i></a></div><textarea id="edit-guide-desc" rows="5" class="w-full bg-stone-100 dark:bg-stone-900 dark:text-white p-2 rounded text-sm"></textarea><input type="text" id="edit-guide-tip" class="w-full bg-stone-100 dark:bg-stone-900 dark:text-white p-2 rounded text-sm" placeholder="冷知識"></div><div class="flex justify-end gap-3"><button onclick="closeModal('edit-guide-modal')" class="text-sm text-gray-500">取消</button><button id="save-guide-btn" class="text-sm bg-stone-700 text-white px-4 py-2 rounded">儲存</button></div></div></div>
        <div id="toast" class="toast"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getFirestore, doc, onSnapshot, setDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';

        // --- ROBUST FIREBASE INIT ---
        let app, auth, db, appId, firebaseConfig;
        let isOfflineOnly = false;
        let currentUser = null;
        let currentTripId = localStorage.getItem('currentTripId') || 'TRIP-' + Math.floor(1000 + Math.random() * 9000);
        let unsubscribeSnapshot = null;

        // ↓↓↓ 請將您的 Firebase 設定貼在下方 ↓↓↓
        const myFirebaseConfig = {
            apiKey: "AIzaSyByoGa9zSiiOMMSUehtJxY6NfbAZ-p2id0",
            authDomain: "japantrip2026-8485f.firebaseapp.com",
            projectId: "japantrip2026-8485f",
            storageBucket: "japantrip2026-8485f.firebasestorage.app",
            messagingSenderId: "449779505780",
            appId: "1:449779505780:web:ac1e285e6b3d185d2b4f21",
            measurementId: "G-3XHQ301Z4J"
        };
        // ↑↑↑

        try {
            if (Object.keys(myFirebaseConfig).length > 0) {
                firebaseConfig = myFirebaseConfig;
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                appId = 'japan-trip-helper';
            } else if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'japan-trip-helper';
            } else {
                throw new Error("Local file detected");
            }
        } catch (e) {
            console.warn("Running in OFFLINE MODE.");
            isOfflineOnly = true;
            document.getElementById('sync-status').innerText = "離線模式";
        }

        // --- DATA MODELS ---
        let sharedData = {
            tripData: [{ day: "第一天", date: "1/11", title: "抵達東京", events: [] }],
            guideData: [],
            flightData: { depAirport: "TPE", depTime: "02:30", arrAirport: "NRT", arrTime: "06:35", flightNum: "捷星 GK12" },
            appSettings: { title: "東京旅遊", date: "2026.01.11 - 01.18" }
        };
        let localData = { checklist: [], expenses: [], memo: "" };
        
        const storedShared = localStorage.getItem('sharedDataBackup');
        if(storedShared) sharedData = JSON.parse(storedShared);
        
        const storedLocal = localStorage.getItem('localUserData');
        if (storedLocal) { localData = JSON.parse(storedLocal); }
        else {
             localData.checklist = [{ text: "護照", checked: false }, { text: "日幣", checked: false }, { text: "信用卡", checked: false }, { text: "網卡", checked: false }];
        }

        const knownLocations = { "淺草寺": { desc: "東京都內最古老的寺廟...", tip: "求籤如果是「凶」，請將籤詩綁在架子上化解。" }, "雷門": { desc: "淺草寺的表參道入口...", tip: "燈籠底部有龍的雕刻。" } };

        let editingEventState = null; // Track editing state { dayIndex, eventId }

        // --- AUTH & SYNC ---
        const initAuth = async () => {
            if (isOfflineOnly) return;
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(auth, __initial_auth_token); } 
                else { await signInAnonymously(auth); }
            } catch (error) { 
                console.error("Auth Error", error); 
                isOfflineOnly = true; 
                document.getElementById('sync-status').innerText = "離線模式";
            }
        };
        
        if (!isOfflineOnly && auth) {
            onAuthStateChanged(auth, (user) => { if (user) { currentUser = user; initSync(); } });
        }

        function initSync() {
            if (isOfflineOnly) return;
            document.getElementById('current-trip-id').innerText = currentTripId;
            localStorage.setItem('currentTripId', currentTripId);
            if (unsubscribeSnapshot) unsubscribeSnapshot();
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'trips', currentTripId);
            unsubscribeSnapshot = onSnapshot(docRef, (docSnap) => {
                const statusEl = document.getElementById('sync-status');
                if (docSnap.exists()) {
                    const remoteData = docSnap.data();
                    if(remoteData.tripData) sharedData.tripData = remoteData.tripData;
                    if(remoteData.guideData) sharedData.guideData = remoteData.guideData;
                    if(remoteData.flightData) sharedData.flightData = remoteData.flightData;
                    if(remoteData.appSettings) sharedData.appSettings = remoteData.appSettings;
                    localStorage.setItem('sharedDataBackup', JSON.stringify(sharedData));
                    renderSharedUI();
                    statusEl.innerText = "已同步"; statusEl.className = "text-[10px] text-green-600 font-bold bg-green-100 px-2 py-0.5 rounded-full";
                } else {
                    saveShared(); statusEl.innerText = "新旅程";
                }
            }, (error) => { console.error("Sync Error:", error); isOfflineOnly = true; document.getElementById('sync-status').innerText = "離線模式 (權限不足)"; });
        }

        function saveLocal() { localStorage.setItem('localUserData', JSON.stringify(localData)); }
        async function saveShared() {
            localStorage.setItem('sharedDataBackup', JSON.stringify(sharedData));
            if (isOfflineOnly || !currentUser) return;
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'trips', currentTripId);
            try { await setDoc(docRef, sharedData); document.getElementById('sync-status').innerText = "儲存中..."; setTimeout(() => document.getElementById('sync-status').innerText = "已同步", 500); } 
            catch (e) { console.error("Save Error", e); if(e.code === 'permission-denied') { isOfflineOnly = true; document.getElementById('sync-status').innerText = "離線模式 (儲存失敗)"; } }
        }

        // --- EXPORTS ---
        window.copyTripId = () => { navigator.clipboard.writeText(currentTripId).then(() => showToast("代碼已複製")); };
        window.joinTrip = () => {
            if(isOfflineOnly) { showToast("離線模式無法加入旅程"); return; }
            const input = document.getElementById('join-trip-input');
            const newId = input.value.trim().toUpperCase();
            if (!newId) return;
            if (confirm(`切換到 [${newId}]？`)) { currentTripId = newId; initSync(); showToast(`已切換`); input.value = ''; }
        };
        window.togglePlanForm = () => document.getElementById('add-plan-form').classList.toggle('hidden');
        window.toggleGuideForm = () => document.getElementById('add-guide-form').classList.toggle('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.remove('active');
        
        window.openAddPlanModal = () => {
            editingEventState = null;
            document.getElementById('plan-form-title').innerText = "新增行程";
            document.getElementById('plan-text').value = ''; 
            document.getElementById('plan-link').value = '';
            document.getElementById('plan-time').value = '';
            document.getElementById('plan-important').checked = false;
            document.getElementById('add-plan-form').classList.remove('hidden');
        };

        window.editPlanEvent = (dayIndex, eventId) => {
            // Find event
            const day = sharedData.tripData[dayIndex];
            const evt = day.events.find(e => String(e.id) === String(eventId));
            if (!evt) return;

            editingEventState = { dayIndex, eventId };
            
            // Populate form
            document.getElementById('plan-form-title').innerText = "編輯行程";
            document.getElementById('plan-day-select').value = dayIndex;
            document.getElementById('plan-time').value = evt.time;
            document.getElementById('plan-type').value = evt.type;
            document.getElementById('plan-text').value = evt.text;
            document.getElementById('plan-link').value = evt.link || '';
            document.getElementById('plan-important').checked = evt.important || false;
            
            document.getElementById('add-plan-form').classList.remove('hidden');
        };

        window.savePlanEvent = () => {
            const dayIndex = parseInt(document.getElementById('plan-day-select').value);
            const time = document.getElementById('plan-time').value;
            const type = document.getElementById('plan-type').value;
            const text = document.getElementById('plan-text').value;
            const link = document.getElementById('plan-link').value;
            const important = document.getElementById('plan-important').checked;

            if (!time || !text) { showToast('請輸入內容'); return; }

            if (editingEventState) {
                // Edit Mode
                // Remove from old location (might be different day if user changed day select)
                const oldDayIdx = editingEventState.dayIndex;
                const oldDay = sharedData.tripData[oldDayIdx];
                const evtId = editingEventState.eventId;
                
                // Remove old event
                oldDay.events = oldDay.events.filter(e => String(e.id) !== String(evtId));
                
                // Add new event (keep ID)
                sharedData.tripData[dayIndex].events.push({ id: evtId, time, text, type, link, important });
                
                showToast('行程已更新');
            } else {
                // Add Mode
                sharedData.tripData[dayIndex].events.push({ id: Date.now() + Math.random(), time, text, type, link, important });
                showToast('行程已新增');
            }

            saveShared();
            document.getElementById('add-plan-form').classList.add('hidden');
            renderPlan(); 
        };

        // Renamed from addPlanEvent to avoid confusion, though button calls savePlanEvent now
        
        window.deletePlanEvent = (dIdx, eId) => { showConfirm('刪除？', () => { sharedData.tripData[dIdx].events = sharedData.tripData[dIdx].events.filter(e => String(e.id) !== String(eId)); saveShared(); renderPlan(); }); };
        window.addNewDay = () => { sharedData.tripData.push({ day: `第${sharedData.tripData.length+1}天`, date: "日期待定", title: "自由活動", events: [] }); saveShared(); renderPlan(); };
        window.deleteDay = (idx) => { showConfirm('刪除整天？', () => { sharedData.tripData.splice(idx, 1); saveShared(); renderPlan(); }); };
        window.editDayHeader = (idx) => { const d = sharedData.tripData[idx]; showEditDayModal(d.date, d.title, (nD, nT) => { d.date = nD; d.title = nT; saveShared(); renderPlan(); }); };

        window.addGuideItem = () => {
            const title = document.getElementById('guide-title').value, desc = document.getElementById('guide-desc').value, tip = document.getElementById('guide-tip').value;
            if(!title) return;
            sharedData.guideData.push({ id: Date.now(), title, desc, tip }); saveShared(); window.toggleGuideForm(); renderGuide();
        };
        document.getElementById('save-guide-btn').onclick = () => {
            const title = document.getElementById('edit-guide-title').value, desc = document.getElementById('edit-guide-desc').value, tip = document.getElementById('edit-guide-tip').value;
            const idx = sharedData.guideData.findIndex(i => i.title === title);
            if(idx >= 0) { sharedData.guideData[idx].desc = desc; sharedData.guideData[idx].tip = tip; } else { sharedData.guideData.push({ id: Date.now(), title, desc, tip }); }
            saveShared(); closeModal('edit-guide-modal'); renderGuide();
        };

        window.initWallet = () => loadExpenses();
        window.addExpense = async () => {
            const name = document.getElementById('expense-name').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            if(!name || !amount) { showToast("請輸入"); return; }
            const fileInput = document.getElementById('expense-photo');
            let photoData = null;
            if(fileInput.files && fileInput.files[0]) { try { photoData = await processImage(fileInput.files[0]); } catch(e){} }
            localData.expenses.unshift({ id: Date.now(), date: new Date().toLocaleString('zh-TW', {month:'numeric', day:'numeric', hour:'2-digit', minute:'2-digit'}), name, amount, photo: photoData });
            saveLocal(); loadExpenses(); document.getElementById('expense-name').value = ''; document.getElementById('expense-amount').value = ''; fileInput.value = ''; showToast('已記帳');
        };
        window.deleteExpense = (id) => { showConfirm('刪除？', () => { localData.expenses = localData.expenses.filter(e => String(e.id) !== String(id)); saveLocal(); loadExpenses(); }); };

        window.addChecklistItem = () => { const val = document.getElementById('new-checklist-item').value; if(val) { localData.checklist.push({text: val, checked: false}); saveLocal(); renderChecklist(); document.getElementById('new-checklist-item').value = ''; } };
        window.toggleCheck = (i) => { localData.checklist[i].checked = !localData.checklist[i].checked; saveLocal(); renderChecklist(); };
        window.deleteChecklistItem = (i) => { showConfirm('刪除？', () => { localData.checklist.splice(i, 1); saveLocal(); renderChecklist(); }); };
        window.initMemo = () => { document.getElementById('memo-area').addEventListener('input', (e) => { localData.memo = e.target.value; clearTimeout(window.saveTimeout); window.saveTimeout = setTimeout(saveLocal, 500); }); document.getElementById('memo-area').value = localData.memo; parseMemoLinks(); };
        
        window.saveAppSettings = () => { sharedData.appSettings = { title: document.getElementById('setting-title').value, date: document.getElementById('setting-date').value }; saveShared(); renderAppSettings(); showToast('設定已儲存'); };
        window.saveFlightInfo = () => { sharedData.flightData = { depAirport: document.getElementById('edit-dep-airport').value, depTime: document.getElementById('edit-dep-time').value, arrAirport: document.getElementById('edit-arr-airport').value, arrTime: document.getElementById('edit-arr-time').value, flightNum: document.getElementById('edit-flight-num').value }; saveShared(); closeModal('edit-flight-modal'); initFlightInfo(); showToast('航班已更新'); };
        window.openEditGuideModal = (t, d, tip) => { document.getElementById('edit-guide-title').value = t; document.getElementById('edit-guide-desc').value = d; document.getElementById('edit-guide-tip').value = tip; document.getElementById('edit-guide-search').href = `https://www.google.com/search?q=${encodeURIComponent(t + " 介紹")}`; document.getElementById('edit-guide-modal').classList.add('active'); };
        window.openFlightModal = () => { const d = sharedData.flightData || {}; document.getElementById('edit-dep-airport').value = d.depAirport || ""; document.getElementById('edit-dep-time').value = d.depTime || ""; document.getElementById('edit-arr-airport').value = d.arrAirport || ""; document.getElementById('edit-arr-time').value = d.arrTime || ""; document.getElementById('edit-flight-num').value = d.flightNum || ""; document.getElementById('edit-flight-modal').classList.add('active'); };
        window.clearAllData = () => { showConfirm("重置所有？", async () => { sharedData = { tripData: [], guideData: [], flightData: {}, appSettings: {} }; localData = { expenses: [], checklist: [], memo: "" }; await saveShared(); saveLocal(); location.reload(); }); };
        window.switchTab = (tabId) => { document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active')); document.getElementById(`tab-${tabId}`).classList.add('active'); document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active')); document.querySelector(`.nav-btn[data-target="${tabId}"]`).classList.add('active'); window.scrollTo(0,0); localStorage.setItem('activeTab', tabId); if(tabId === 'guide') renderGuide(); };
        window.toggleDarkMode = () => { const isDark = document.documentElement.classList.toggle('dark'); localStorage.setItem('darkMode', isDark); updateDarkModeIcon(isDark); };
        function updateDarkModeIcon(isDark) { const i = document.getElementById('dark-mode-icon'); if(isDark) { i.className = 'fa-solid fa-sun text-lg'; } else { i.className = 'fa-solid fa-moon text-lg'; } }
        function initDarkMode() { const m = localStorage.getItem('darkMode'); if(m !== 'false') document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark'); updateDarkModeIcon(m !== 'false'); }
        window.parseMemoLinks = parseMemoLinks;
        function parseMemoLinks() { const area = document.getElementById('memo-area'); const container = document.getElementById('memo-links'); container.innerHTML = ''; const matches = area.value.match(/(https?:\/\/[^\s]+)/g); if(matches) matches.forEach(url => { const a = document.createElement('a'); a.href = url; a.target = "_blank"; a.className = "inline-flex items-center gap-1 bg-stone-200 dark:bg-stone-700 text-stone-600 dark:text-stone-300 px-3 py-1 rounded-full text-xs max-w-full truncate hover:bg-stone-300 dark:hover:bg-stone-600 transition"; a.innerHTML = `<i class="fa-solid fa-link text-[10px]"></i> 連結`; container.appendChild(a); }); }
        window.viewImage = (b64) => { const win = window.open(""); win.document.write(`<img src="${b64}" style="width:100%; height:auto; background:#333;">`); };
        function processImage(file) { return new Promise((res, rej) => { const r = new FileReader(); r.readAsDataURL(file); r.onload = e => { const img = new Image(); img.src = e.target.result; img.onload = () => { const c = document.createElement('canvas'), MAX = 300; let w = img.width, h = img.height; if (w > h) { if (w > MAX) { h *= MAX / w; w = MAX; } } else { if (h > MAX) { w *= MAX / h; h = MAX; } } c.width = w; c.height = h; c.getContext('2d').drawImage(img, 0, 0, w, h); res(c.toDataURL('image/jpeg', 0.6)); }; img.onerror = rej; }; r.onerror = rej; }); }

        // Render Functions
        function renderSharedUI() { renderPlan(); renderGuide(); renderAppSettings(); initFlightInfo(); }
        function renderLocalUI() { loadExpenses(); renderChecklist(); document.getElementById('memo-area').value = localData.memo; parseMemoLinks(); }
        
        function loadExpenses() {
            const list = document.getElementById('expense-list'); const expenses = localData.expenses || []; const rate = parseFloat(document.getElementById('exchange-rate').value) || 0.22;
            if(expenses.length === 0) { list.innerHTML = '<div class="text-center text-stone-400 text-xs py-4">尚未有記帳紀錄。</div>'; return; }
            let html = ''; let totalJPY = 0;
            expenses.forEach(ex => {
                totalJPY += ex.amount; const twd = Math.round(ex.amount * rate);
                const hasPhoto = ex.photo ? `<img src="${ex.photo}" class="w-10 h-10 object-cover rounded-lg border border-stone-200 dark:border-stone-600" onclick="viewImage('${ex.photo}')">` : '<div class="w-10 h-10 bg-stone-100 dark:bg-stone-700 rounded-lg flex items-center justify-center text-stone-300 dark:text-stone-500"><i class="fa-solid fa-receipt"></i></div>';
                html += `<div class="flex items-center gap-3 bg-white dark:bg-stone-800 p-3 rounded-xl shadow-sm border border-stone-50 dark:border-stone-700 transition-colors duration-300">${hasPhoto}<div class="flex-1 min-w-0"><div class="text-sm font-bold text-muji-text dark:text-stone-200 truncate">${ex.name}</div><div class="text-[10px] text-stone-400 dark:text-stone-500">${ex.date}</div></div><div class="text-right"><div class="text-sm font-bold text-muji-text dark:text-stone-200">¥${ex.amount.toLocaleString()}</div><div class="text-[10px] text-stone-400 dark:text-stone-500">≈ NT$${twd.toLocaleString()}</div></div><button onclick="deleteExpense('${ex.id}')" class="text-stone-300 hover:text-red-400 px-2"><i class="fa-solid fa-trash"></i></button></div>`;
            });
            list.innerHTML = `<div class="bg-stone-200 dark:bg-stone-700 p-3 rounded-lg mb-4 text-center transition-colors duration-300"><span class="text-xs text-stone-500 dark:text-stone-400">總計:</span> <span class="font-bold text-stone-700 dark:text-stone-200">¥${totalJPY.toLocaleString()}</span><span class="text-xs text-stone-400 dark:text-stone-500">(~NT$${Math.round(totalJPY * rate).toLocaleString()})</span></div>${html}`;
        }

        function renderPlan() {
            const container = document.getElementById('itinerary-container'); const daySelect = document.getElementById('plan-day-select');
            let html = ''; let selectHtml = '';
            // Add day if empty
            if(!sharedData.tripData || sharedData.tripData.length === 0) { sharedData.tripData = [{ day: "第一天", date: "1/11", title: "抵達東京", events: [] }]; }
            sharedData.tripData.forEach((day, index) => {
                selectHtml += `<option value="${index}">${day.day} (${day.date})</option>`;
                let eventsHtml = '';
                (day.events || []).sort((a, b) => a.time.localeCompare(b.time)).forEach((evt) => {
                    const icon = getIconByType(evt.type);
                    const highlightClass = evt.important ? 'bg-amber-50 border-amber-200 dark:bg-amber-900/20 dark:border-amber-900/50' : 'bg-white border-transparent dark:bg-stone-800 dark:border-stone-700';
                    const timeColor = evt.important ? 'text-amber-600 dark:text-amber-500 font-bold' : 'text-muji-text dark:text-stone-400';
                    let actionBtn = evt.link ? `<a href="${evt.link}" target="_blank" class="ml-2 text-xs bg-stone-100 dark:bg-stone-700 px-2 py-0.5 rounded text-stone-500 dark:text-stone-300 hover:bg-stone-200 dark:hover:bg-stone-600"><i class="fa-solid fa-map-location-dot"></i> 地圖</a>` : '';
                    // Added EDIT button next to DELETE
                    eventsHtml += `<div class="flex gap-4 relative group"><div class="flex flex-col items-center"><div class="w-2 h-2 rounded-full bg-stone-300 dark:bg-stone-600 mt-2"></div><div class="w-0.5 flex-1 bg-stone-200 dark:bg-stone-700 my-1"></div></div><div class="flex-1 pb-6 relative"><div class="absolute top-0 right-0 z-10 flex gap-1"><button onclick="editPlanEvent(${index}, '${evt.id}')" class="text-stone-300 hover:text-stone-500 p-2"><i class="fa-solid fa-pen"></i></button><button onclick="deletePlanEvent(${index}, '${evt.id}')" class="text-stone-300 hover:text-red-400 p-2"><i class="fa-solid fa-xmark"></i></button></div><div class="text-xs ${timeColor} mb-0.5">${evt.time}</div><div class="p-3 rounded-lg border shadow-sm ${highlightClass} transition-colors duration-300"><div class="flex items-start gap-2"><i class="${icon} text-stone-400 dark:text-stone-500 mt-1 text-xs"></i><div class="text-sm text-muji-text dark:text-stone-200 font-medium leading-tight pr-6">${evt.text}${actionBtn}</div></div></div></div></div>`;
                });
                html += `<div class="relative group"><div class="sticky top-16 z-10 bg-[#f4f4f0]/95 dark:bg-[#1c1917]/95 py-2 mb-2 border-b border-stone-200 dark:border-stone-800 backdrop-blur-sm transition-colors duration-300 flex justify-between items-end"><h2 class="font-serif font-bold text-lg text-muji-text dark:text-stone-100 flex items-baseline gap-2 cursor-pointer" onclick="editDayHeader(${index})">${day.date} <span class="text-sm font-sans text-muji-accent dark:text-stone-500 font-normal">${day.day} - ${day.title}</span></h2><div class="flex gap-2"><button onclick="editDayHeader(${index})" class="text-stone-300 hover:text-stone-500 dark:hover:text-stone-300 text-xs p-2 bg-stone-100 dark:bg-stone-800 rounded-full"><i class="fa-solid fa-pen"></i></button><button onclick="deleteDay(${index})" class="text-stone-300 hover:text-red-400 text-xs p-2 bg-stone-100 dark:bg-stone-800 rounded-full"><i class="fa-solid fa-trash"></i></button></div></div><div class="pl-2">${eventsHtml}</div></div>`;
            });
            container.innerHTML = html; daySelect.innerHTML = selectHtml; renderGuide();
        }

        function renderGuide() {
            const container = document.getElementById('guide-container');
            const itinerarySpots = new Set();
            sharedData.tripData.forEach(day => { (day.events || []).forEach(evt => { if (evt.type === 'spot') itinerarySpots.add(evt.text); }); });
            if (!Array.isArray(sharedData.guideData)) sharedData.guideData = [];
            const allTitles = new Set([...itinerarySpots, ...sharedData.guideData.map(g => g.title)]);
            let html = '';
            if (allTitles.size === 0) html = '<div class="text-center text-stone-400 text-sm py-10">尚無景點，請在「行程表」新增類型為「景點」的項目。</div>';
            else {
                allTitles.forEach(title => {
                    const existingGuide = sharedData.guideData.find(g => g.title === title);
                    let desc = existingGuide ? existingGuide.desc : null; let tip = existingGuide ? existingGuide.tip : null; let isAutoFilled = false;
                    if (!desc) { for (const [key, value] of Object.entries(knownLocations)) { if (title.includes(key)) { desc = value.desc; tip = value.tip; isAutoFilled = true; break; } } }
                    if (!desc) desc = "點擊此處新增景點介紹...";
                    const tipHtml = tip ? `<div class="bg-stone-50 dark:bg-stone-900/50 p-3 rounded-lg text-xs text-stone-600 dark:text-stone-300 border border-stone-100 dark:border-stone-700 mt-4"><span class="font-bold text-muji-primary dark:text-stone-400">💡 冷知識：</span> ${tip}</div>` : '';
                    const safeTitle = title.replace(/'/g, "\\'").replace(/"/g, '&quot;'); const safeDesc = desc.replace(/'/g, "\\'").replace(/"/g, '&quot;'); const safeTip = tip ? tip.replace(/'/g, "\\'").replace(/"/g, '&quot;') : '';
                    html += `<div class="bg-muji-card dark:bg-stone-800 rounded-xl overflow-hidden shadow-sm mb-6 border border-stone-100 dark:border-stone-700 transition-colors duration-300 relative group cursor-pointer" onclick="openEditGuideModal('${safeTitle}', '${existingGuide ? safeDesc : (isAutoFilled ? safeDesc : '')}', '${safeTip}')"><div class="absolute top-3 right-3 text-stone-300 p-2"><i class="fa-solid fa-pen"></i></div><div class="h-32 bg-stone-200 dark:bg-stone-700 relative overflow-hidden flex items-center justify-center"><i class="fa-solid fa-image text-4xl text-stone-300 dark:text-stone-600"></i></div><div class="p-5"><h3 class="font-serif text-lg font-bold text-muji-text dark:text-stone-100 mb-2">${title}</h3><p class="text-xs text-muji-accent dark:text-stone-400 leading-relaxed text-justify ${(!existingGuide && !isAutoFilled) ? 'italic opacity-50' : ''}">${desc}</p>${tipHtml}</div></div>`;
                });
            }
            container.innerHTML = html;
        }

        function renderChecklist() {
            const container = document.getElementById('checklist-container'); const progress = document.getElementById('checklist-progress');
            const items = localData.checklist || [];
            let html = ''; let checkedCount = 0;
            if (items.length === 0) html = '<li class="text-center text-stone-400 text-xs py-2">清單是空的</li>';
            else {
                items.forEach((item, index) => {
                    if(item.checked) checkedCount++;
                    html += `<li class="flex items-center gap-3 bg-white dark:bg-stone-800 p-3 rounded-lg border border-stone-100 dark:border-stone-700 shadow-sm transition-colors duration-300 group"><input type="checkbox" id="check-${index}" class="muji-checkbox w-5 h-5 rounded border-stone-300 dark:border-stone-600 text-stone-600 focus:ring-stone-400 bg-white dark:bg-stone-700" ${item.checked ? 'checked' : ''} onchange="toggleCheck(${index})"><label for="check-${index}" class="text-sm text-muji-text dark:text-stone-200 flex-1 ${item.checked ? 'line-through text-stone-400 dark:text-stone-600' : ''}">${item.text}</label><button onclick="deleteChecklistItem(${index})" class="text-stone-300 hover:text-red-400 p-1"><i class="fa-solid fa-xmark"></i></button></li>`;
                });
            }
            container.innerHTML = html; progress.innerText = `${checkedCount}/${items.length}`;
        }
        function renderAppSettings() { const s = sharedData.appSettings || {}; document.getElementById('app-title').innerText = s.title || "東京旅遊"; document.getElementById('app-date').innerText = s.date || "2026.01.11 - 01.18"; document.getElementById('setting-title').value = s.title || ""; document.getElementById('setting-date').value = s.date || ""; }
        function initFlightInfo() { const d = sharedData.flightData || {}; document.getElementById('disp-dep-airport').innerText = d.depAirport; document.getElementById('disp-dep-time').innerText = d.depTime; document.getElementById('disp-arr-airport').innerText = d.arrAirport; document.getElementById('disp-arr-time').innerText = d.arrTime; document.getElementById('disp-flight-num').innerText = d.flightNum; }
        function getIconByType(type) { const map = { 'transport': 'fa-solid fa-train-subway', 'food': 'fa-solid fa-utensils', 'hotel': 'fa-solid fa-bed', 'spot': 'fa-solid fa-camera', 'shopping': 'fa-solid fa-bag-shopping' }; return map[type] || 'fa-solid fa-circle'; }
        function showToast(msg) { const toast = document.getElementById('toast'); toast.innerText = msg; toast.classList.add('active'); setTimeout(() => toast.classList.remove('active'), 2500); }
        let confirmCallback, editDayCallback;
        function showConfirm(msg, cb) { document.getElementById('confirm-message').innerText = msg; confirmCallback = cb; document.getElementById('confirm-modal').classList.add('active'); }
        function showEditDayModal(d, t, cb) { document.getElementById('edit-day-date').value = d; document.getElementById('edit-day-title').value = t; editDayCallback = cb; document.getElementById('edit-day-modal').classList.add('active'); }
        document.getElementById('confirm-btn').onclick = () => { if(confirmCallback) confirmCallback(); closeModal('confirm-modal'); };
        document.getElementById('save-day-btn').onclick = () => { if(editDayCallback) editDayCallback(document.getElementById('edit-day-date').value, document.getElementById('edit-day-title').value); closeModal('edit-day-modal'); };

        renderLocalUI();
        initAuth();
    </script>
</body>
</html>